<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
  <link rel="shortcut icon" href="favicon.ico">
  <link rel="manifest" href="site.webmanifest">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="neora-mobile.css">
  <title>NEORA SIMPLE</title>
  
  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <script src="neora-auth-persist.js"></script>
  <script src="neora-tracker.js"></script>
  
  <style>
    :root{
      --bg0:#050714;
      --bg1:#070a1a;

      /* panels glass */
      --card: rgba(255,255,255,.045);
      --border: rgba(255,255,255,.14);

      /* text */
      --text: rgba(255,255,255,.95);
      --muted: rgba(255,255,255,.75);
      --muted2: rgba(255,255,255,.60);

      --shadow2: 0 20px 70px rgba(0,0,0,.65);
      --radius:20px;
      --focus: 0 0 0 4px rgba(99,102,241,.28);
      --grad: linear-gradient(135deg,#6366f1,#a855f7 35%,#ec4899 65%,#22d3ee);

      /* input glass */
      --field-bg: rgba(0,0,0,.38);
      --field-border: rgba(255,255,255,.18);
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      color:var(--text);
      background:
        radial-gradient(1200px 600px at 20% 0%, rgba(99,102,241,.22), transparent 60%),
        radial-gradient(900px 500px at 80% 10%, rgba(236,72,153,.18), transparent 55%),
        radial-gradient(900px 700px at 50% 110%, rgba(34,211,238,.12), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow-x:hidden;
    }

    /* Topbar */
    .topbar{
      position:sticky; top:0; z-index:10;
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      background: linear-gradient(180deg, rgba(5,7,20,.76), rgba(5,7,20,.48));
      border-bottom: 1px solid rgba(255,255,255,.08);
    }
    .topbar-inner{
      max-width:1100px;
      margin:0 auto;
      padding:16px 20px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:14px;
    }
    .brand{ display:flex; align-items:center; gap:12px; user-select:none; }
    .logo{
      width:34px; height:34px; border-radius:10px;
      background: url('logo.jpg') center/cover no-repeat;
      box-shadow: 0 14px 40px rgba(99,102,241,.22);
      position:relative;
    }
    .brand h1{
      margin:0;
      font-size:15px;
      letter-spacing:.35em;
      text-transform:uppercase;
      line-height:1;
      color: rgba(255,255,255,.95);
    }
    .badge{
      font-size:12px;
      color: rgba(255,255,255,.78);
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.045);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      box-shadow: 0 10px 30px rgba(0,0,0,.22);
      white-space:nowrap;
    }

    /* Layout */
    .wrap{
      max-width:1100px;
      margin: 0 auto;
      padding: 22px 20px 34px;
    }
    .grid{
      display:grid;
      grid-template-columns: 420px 1fr;
      gap:16px;
      align-items:start;
    }
    @media (max-width: 980px){
      .grid{ grid-template-columns:1fr; }
    }

    .panel{
      background: linear-gradient(180deg, var(--card), rgba(255,255,255,.02));
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow2);
      overflow:hidden;
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
    }
    .panel .head{
      padding:18px 18px 14px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
    }
    .title{
      margin:0;
      font-size:16px;
      letter-spacing:.02em;
      color: rgba(255,255,255,.92);
    }
    .subtitle{
      margin:6px 0 0;
      font-size:13px;
      color: var(--muted);
      line-height:1.4;
    }
    .panel .body{ padding:16px 18px 18px; }

    label{
      display:block;
      font-size:12px;
      color: var(--muted);
      margin: 12px 0 6px;
      letter-spacing:.02em;
    }

    textarea, select, input[type="text"]{
      width:100%;
      border-radius: 14px;
      border:1px solid var(--field-border);
      background: var(--field-bg);
      color: rgba(255,255,255,.95);
      padding: 12px 12px;
      outline:none;
      transition: border .15s ease, box-shadow .15s ease, background .15s ease;
      box-shadow: 0 10px 30px rgba(0,0,0,.22);
    }
    textarea{
      min-height: 140px;
      resize: vertical;
    }
    textarea:focus, select:focus, input[type="text"]:focus{
      border-color: rgba(99,102,241,.62);
      box-shadow: var(--focus), 0 12px 34px rgba(0,0,0,.30);
      background: rgba(0,0,0,.38);
    }

    .row2{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
    }
    @media (max-width: 520px){
      .row2{ grid-template-columns:1fr; }
    }

    /* Upload */
    .drop{
      border-radius: 16px;
      border: 1px dashed rgba(255,255,255,.20);
      background: rgba(0,0,0,.22);
      padding: 14px;
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:space-between;
      transition: border .15s ease, background .15s ease;
      box-shadow: 0 10px 30px rgba(0,0,0,.18);
    }
    .drop:hover{
      border-color: rgba(99,102,241,.45);
      background: rgba(0,0,0,.28);
    }
    .drop-left{ display:flex; gap:12px; align-items:center; min-width:0; }
    .upload-ico{
      width:38px; height:38px;
      border-radius: 14px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
      display:grid; place-items:center;
      flex:0 0 auto;
    }
    .drop-meta{ min-width:0; }
    .drop-title{
      font-size:13px; margin:0; color: rgba(255,255,255,.90);
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .drop-sub{
      margin:4px 0 0; font-size:12px; color: var(--muted2);
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .drop-actions{ display:flex; gap:8px; align-items:center; flex:0 0 auto; }

    .btn-small{
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.92);
      padding: 9px 10px;
      border-radius: 999px;
      cursor:pointer;
      transition: transform .12s ease, background .12s ease, border .12s ease;
      font-weight:900;
      font-size:12px;
    }
    .btn-small:hover{ transform: translateY(-1px); background: rgba(255,255,255,.09); }
    .btn-small:active{ transform: translateY(0px); }

    input[type="file"]{ display:none; }

    /* Buttons */
    .btnrow{
      display:flex; gap:10px; margin-top:14px; flex-wrap:wrap;
    }
    .btn{
      flex:1 1 auto;
      border-radius: 999px;
      padding: 12px 14px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.94);
      cursor:pointer;
      font-weight:900;
      letter-spacing:.02em;
      transition: transform .12s ease, background .12s ease, box-shadow .12s ease;
      box-shadow: 0 12px 34px rgba(0,0,0,.28);
    }
    .btn:hover{ transform: translateY(-1px); background: rgba(255,255,255,.09); }
    .btn:active{ transform: translateY(0px); }
    .btn:disabled{ opacity:.55; cursor:not-allowed; transform:none; }

    .btn-primary{
      border:none;
      background: var(--grad);
      color:#fff;
      box-shadow: 0 18px 45px rgba(99,102,241,.22);
    }

    .status{
      margin-top:12px;
      font-size:12.5px;
      color: rgba(255,255,255,.72);
      min-height: 1.2em;
      white-space: pre-wrap;
    }

    /* Preview */
    .preview-head{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
    }
    .hint{
      font-size:12px;
      color: var(--muted);
      margin-top:6px;
      line-height:1.45;
    }
    .frame{
      margin-top:14px;
      border-radius: var(--radius);
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.22);
      overflow:hidden;
      position:relative;
      min-height: 320px;
      display:grid;
      place-items:center;
      box-shadow: 0 18px 60px rgba(0,0,0,.38);
    }
    .frame img{
      width:100%;
      height:100%;
      object-fit:contain;
      display:block;
      max-height: 660px;
    }
    .empty{
      padding: 34px 18px;
      text-align:center;
      color: rgba(255,255,255,.65);
      font-size:13px;
      line-height:1.55;
    }
    .empty strong{
      color: rgba(255,255,255,.92);
      font-weight:900;
    }
    .overlay{
      position:absolute; inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      background: rgba(5,7,20,.62);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
    }
    .overlay-inner{
      display:flex; align-items:center; gap:12px;
      padding: 12px 14px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.94);
      box-shadow: 0 18px 60px rgba(0,0,0,.35);
      font-weight:900;
      font-size:13px;
    }
    .spin{
      width:18px; height:18px;
      border-radius:999px;
      border: 3px solid rgba(255,255,255,.24);
      border-top-color: rgba(255,255,255,.95);
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin{ to{ transform: rotate(360deg);} }

    .meta{
      margin-top:10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      color: var(--muted2);
      font-size:12px;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 7px 10px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }

    .link{
      color: rgba(255,255,255,.92);
      text-decoration:none;
      font-weight:900;
      border-bottom:1px solid rgba(255,255,255,.22);
      padding-bottom:2px;
    }
    .link:hover{ opacity:.92; }

    /* ‚úÖ Aspect ratio */
    #aspectRatio{
      height: 42px !important;
      padding: 8px 38px 8px 12px !important;
      font-size: 13px !important;
      font-weight: 900 !important;
      border-radius: 12px !important;

      background: rgba(255,255,255,.10) !important;
      border: 1px solid rgba(255,255,255,.22) !important;
      color: rgba(255,255,255,.98) !important;

      box-shadow: 0 10px 26px rgba(0,0,0,.22) !important;

      appearance: none;
      -webkit-appearance: none;
      -moz-appearance: none;

      background-image:
        linear-gradient(45deg, transparent 50%, rgba(255,255,255,.95) 50%),
        linear-gradient(135deg, rgba(255,255,255,.95) 50%, transparent 50%);
      background-position:
        calc(100% - 16px) 50%,
        calc(100% - 11px) 50%;
      background-size: 5px 5px, 5px 5px;
      background-repeat: no-repeat;
    }
    #aspectRatio:hover{
      border-color: rgba(99,102,241,.55) !important;
      background: rgba(255,255,255,.13) !important;
    }
    #aspectRatio:focus{
      border-color: rgba(99,102,241,.75) !important;
      box-shadow: 0 0 0 4px rgba(99,102,241,.26), 0 10px 26px rgba(0,0,0,.22) !important;
    }
    #aspectRatio option{
      background: #0b1026 !important;
      color: rgba(255,255,255,.95) !important;
      font-weight: 800 !important;
    }
    
    /* Compteur de cr√©dits */
    .credits-counter {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 14px;
      background: rgba(99,102,241,.12);
      border: 1px solid rgba(99,102,241,.25);
      border-radius: 999px;
      font-size: 13px;
      font-weight: 600;
    }
    .credits-counter .icon { font-size: 15px; }
    .credits-counter .count { color: #a5b4fc; font-weight: 700; }
    .credits-counter.low {
      background: rgba(245,158,11,.12);
      border-color: rgba(245,158,11,.3);
    }
    .credits-counter.low .count { color: #fbbf24; }
    .credits-counter.empty {
      background: rgba(239,68,68,.12);
      border-color: rgba(239,68,68,.3);
    }
    .credits-counter.empty .count { color: #f87171; }

    /* ========== PREMIUM DESIGN ========== */
    
    /* Background effects */
    .bg-effects {
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 0;
      overflow: hidden;
    }
    .bg-gradient {
      position: absolute;
      border-radius: 50%;
      filter: blur(120px);
      opacity: 0.5;
    }
    .bg-gradient-1 {
      width: 800px;
      height: 800px;
      top: -400px;
      left: -200px;
      background: radial-gradient(circle, rgba(99,102,241,0.35) 0%, transparent 70%);
    }
    .bg-gradient-2 {
      width: 600px;
      height: 600px;
      bottom: -300px;
      right: -150px;
      background: radial-gradient(circle, rgba(236,72,153,0.25) 0%, transparent 70%);
    }
    .bg-gradient-3 {
      width: 500px;
      height: 500px;
      top: 30%;
      right: 10%;
      background: radial-gradient(circle, rgba(34,211,238,0.15) 0%, transparent 70%);
    }
    .bg-grid {
      position: absolute;
      inset: 0;
      background-image:
        linear-gradient(rgba(255,255,255,0.02) 1px, transparent 1px),
        linear-gradient(90deg, rgba(255,255,255,0.02) 1px, transparent 1px);
      background-size: 60px 60px;
      mask-image: radial-gradient(ellipse at center, black 20%, transparent 70%);
    }

    .page-container {
      position: relative;
      z-index: 1;
      min-height: 100vh;
    }

    /* Enhanced Topbar */
    .topbar {
      position: sticky;
      top: 0;
      z-index: 100;
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      background: rgba(5,7,20,0.75);
      border-bottom: 1px solid rgba(255,255,255,0.08);
    }
    .topbar-inner {
      max-width: 1200px;
      margin: 0 auto;
      padding: 14px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
    }
    .brand {
      display: flex;
      align-items: center;
      gap: 12px;
      text-decoration: none;
      color: inherit;
    }
    .logo {
      width: 36px;
      height: 36px;
      border-radius: 10px;
      background: url('logo.jpg') center/cover no-repeat;
      box-shadow: 0 8px 30px rgba(99,102,241,0.25);
    }
    .logo-text {
      font-size: 20px;
      font-weight: 700;
      letter-spacing: -0.02em;
    }
    .logo-text span {
      background: var(--grad);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    /* Navigation */
    .nav-links {
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .nav-link {
      padding: 8px 14px;
      border-radius: 999px;
      font-size: 13px;
      font-weight: 500;
      text-decoration: none;
      color: rgba(255,255,255,0.65);
      transition: all 0.2s ease;
    }
    .nav-link:hover {
      color: rgba(255,255,255,0.95);
      background: rgba(255,255,255,0.08);
    }
    .nav-link.active {
      color: rgba(255,255,255,0.95);
      background: rgba(99,102,241,0.15);
    }

    .topbar-right {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .btn-logout {
      padding: 9px 18px;
      font-size: 13px;
      font-weight: 600;
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.12);
      color: rgba(255,255,255,0.85);
      border-radius: 999px;
      cursor: pointer;
      transition: all 0.2s ease;
      font-family: inherit;
    }
    .btn-logout:hover {
      background: rgba(255,255,255,0.1);
      transform: translateY(-1px);
    }

    @media (max-width: 900px) {
      .nav-links { display: none; }
    }
    @media (max-width: 600px) {
      .topbar-inner { padding: 12px 16px; }
      .logo-text { display: none; }
    }

    /* Enhanced Panel */
    .panel {
      background: linear-gradient(180deg, rgba(255,255,255,0.05), rgba(255,255,255,0.02));
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 24px;
      box-shadow: 
        0 25px 80px rgba(0,0,0,0.5),
        inset 0 1px 0 rgba(255,255,255,0.05);
      overflow: hidden;
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
    }
    .panel .head {
      padding: 20px 22px 16px;
      border-bottom: 1px solid rgba(255,255,255,0.06);
      background: linear-gradient(180deg, rgba(255,255,255,0.04), transparent);
    }
    .title {
      margin: 0;
      font-size: 18px;
      font-weight: 700;
      letter-spacing: -0.01em;
      color: rgba(255,255,255,0.95);
    }
    .subtitle {
      margin: 8px 0 0;
      font-size: 13px;
      color: rgba(255,255,255,0.55);
      line-height: 1.5;
    }
    .panel .body {
      padding: 18px 22px 22px;
    }

    /* Enhanced Frame */
    .frame {
      margin-top: 14px;
      border-radius: 20px;
      border: 1px solid rgba(255,255,255,0.1);
      background: rgba(0,0,0,0.3);
      overflow: hidden;
      position: relative;
      min-height: 340px;
      display: grid;
      place-items: center;
      box-shadow: 
        0 20px 60px rgba(0,0,0,0.4),
        inset 0 1px 0 rgba(255,255,255,0.03);
    }

    /* Enhanced Buttons */
    .btn-primary {
      border: none;
      background: var(--grad);
      color: #fff;
      box-shadow: 
        0 15px 40px rgba(99,102,241,0.3),
        inset 0 1px 0 rgba(255,255,255,0.2);
      position: relative;
      overflow: hidden;
    }
    .btn-primary::before {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(180deg, rgba(255,255,255,0.15), transparent);
      opacity: 0;
      transition: opacity 0.2s ease;
    }
    .btn-primary:hover::before {
      opacity: 1;
    }
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 
        0 20px 50px rgba(99,102,241,0.4),
        inset 0 1px 0 rgba(255,255,255,0.2);
    }

    /* Badge FREE */
    .badge-free {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      background: linear-gradient(135deg, rgba(34,211,238,0.15), rgba(99,102,241,0.15));
      border: 1px solid rgba(34,211,238,0.25);
      border-radius: 999px;
      font-size: 11px;
      font-weight: 700;
      color: #22d3ee;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
  </style>
</head>

<body>
  <!-- Background effects -->
  <div class="bg-effects">
    <div class="bg-gradient bg-gradient-1"></div>
    <div class="bg-gradient bg-gradient-2"></div>
    <div class="bg-gradient bg-gradient-3"></div>
    <div class="bg-grid"></div>
  </div>

  <div class="page-container">
    <nav class="topbar">
      <div class="topbar-inner">
        <a href="index.html" class="brand">
          <div class="logo"></div>
          <div class="logo-text">Neora<span>.ai</span></div>
        </a>

        <div class="nav-links">
          <a href="index.html" class="nav-link">Accueil</a>
          <a href="pricing.html" class="nav-link">Tarifs</a>
          <a href="historique.html" class="nav-link">Historique</a>
          <a href="profil.html" class="nav-link">Profil</a>
          <a href="contact.html" class="nav-link">Contact</a>
        </div>

        <div class="topbar-right">
          <span class="badge-free">‚ú® Free</span>
          <div class="credits-counter" id="creditsCounter">
            <span class="icon">‚ö°</span>
            <span class="count" id="creditsCount">-</span>
            <span>cr√©dits</span>
          </div>
          <button class="btn-logout" onclick="logout()">D√©connexion</button>
        </div>
      </div>
    </nav>

  <div class="wrap">
    <div class="grid">
      <!-- Controls -->
      <div class="panel">
        <div class="head">
          <div style="display: flex; align-items: center; justify-content: space-between;">
            <h2 class="title">üé® Create</h2>
            <span class="badge-free">Version Gratuite</span>
          </div>
          <p class="subtitle">D√©cris ce que tu veux g√©n√©rer. Ajoute une image si tu veux transformer un produit existant.</p>
        </div>
        <div class="body">
          <!-- Templates de prompts -->
          <div id="promptTemplates"></div>
          
          <label for="prompt_user">‚ú® Prompt</label>
          <textarea id="prompt_user" placeholder="Ex: Visuel marketing premium, √©clairage studio, rendu photor√©aliste, fond sombre minimal..."></textarea>

          <label>üì∑ Image (optionnel)</label>
          <div class="drop" id="dropZone">
            <div class="drop-left">
              <div class="upload-ico">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                  <path d="M12 16V4m0 0l-4 4m4-4l4 4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  <path d="M4 16v2a2 2 0 002 2h12a2 2 0 002-2v-2" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
              </div>
              <div class="drop-meta">
                <p class="drop-title" id="fileTitle">Drop image here (or browse)</p>
                <p class="drop-sub" id="fileSub">PNG / JPG ‚Ä¢ optional</p>
              </div>
            </div>
            <div class="drop-actions">
              <button type="button" class="btn-small" id="browseBtn">Browse</button>
              <button type="button" class="btn-small" id="clearBtn">Clear</button>
            </div>
            <input type="file" id="product_image" accept="image/*" />
          </div>

          <div class="row2" style="margin-top:12px;">
            <div>
              <label>üìê Resolution</label>
              <div class="pill"><span class="mono">2K</span></div>
            </div>
            <div>
              <label for="aspectRatio">üìè Aspect ratio</label>
              <select id="aspectRatio">
                <option value="16:9" selected>16:9</option>
                <option value="1:1">1:1</option>
                <option value="4:5">4:5</option>
                <option value="9:16">9:16</option>
                <option value="auto">auto</option>
              </select>
            </div>
          </div>

          <div class="btnrow">
            <button class="btn btn-primary" id="submit-btn">‚ö° Generate</button>
            <button class="btn" id="recheck-btn" disabled>üîÑ Re-check</button>
            <button class="btn" id="reset-btn">üóëÔ∏è Reset</button>
          </div>

          <div class="status" id="status">Ready.</div>
        </div>
      </div>

      <!-- Preview -->
      <div class="panel">
        <div class="head">
          <div style="display: flex; align-items: flex-start; justify-content: space-between; gap: 12px;">
            <div>
              <h2 class="title">üñºÔ∏è Result</h2>
              <p class="subtitle" style="margin-top: 6px;">Ton image g√©n√©r√©e appara√Æt ici.</p>
            </div>
            <a class="link" id="downloadLink" href="#" target="_blank" rel="noreferrer" style="display:none; color: rgba(255,255,255,.92); text-decoration: none; font-weight: 700; padding: 8px 16px; background: rgba(16,185,129,0.15); border: 1px solid rgba(16,185,129,0.3); border-radius: 999px; font-size: 13px;">‚¨áÔ∏è Download</a>
          </div>
        </div>

        <div class="body">
          <div class="frame" id="frame">
            <div class="empty" id="empty">
              <div style="font-size: 48px; margin-bottom: 16px;">üé®</div>
              <div style="font-size: 16px; font-weight: 700; margin-bottom: 8px; color: rgba(255,255,255,0.9);">Aucune image g√©n√©r√©e</div>
              <div style="font-size: 14px; color: rgba(255,255,255,0.5);">√âcris un prompt et clique <b style="color: rgba(255,255,255,0.8);">Generate</b> pour cr√©er</div>
            </div>
            <img id="preview-image" alt="Neora result" style="display:none;" />
            <div class="overlay" id="overlay">
              <div class="overlay-inner">
                <span class="spin"></span>
                <span id="overlayText">Generating‚Ä¶</span>
              </div>
            </div>
          </div>

          <div class="meta">
            <span class="pill">Mode: <span id="mode" class="mono">text-to-image</span></span>
            <span class="pill" id="taskPill" style="display:none;">Task: <span id="taskId" class="mono"></span></span>
          </div>

        </div>
      </div>
    </div>
  </div>
  </div> <!-- Fermeture page-container -->

  <!-- Modal Upgrade Pro -->
  <div id="upgradeModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.85); backdrop-filter:blur(8px); z-index:1000; align-items:center; justify-content:center;">
    <div style="background:linear-gradient(180deg,#12121f,#0a0a14); border:1px solid rgba(255,255,255,.14); border-radius:24px; padding:40px; max-width:420px; width:90%; text-align:center;">
      <div style="font-size:64px; margin-bottom:16px;">üöÄ</div>
      <h2 style="font-size:24px; font-weight:700; margin:0 0 12px;">Passez √† Pro !</h2>
      <p style="color:rgba(255,255,255,.7); font-size:15px; line-height:1.6; margin-bottom:24px;">
        Vous avez utilis√© vos <strong>5 g√©n√©rations gratuites</strong>.<br>
        Passez √† Pro pour d√©bloquer <strong>50 g√©n√©rations/mois</strong> et acc√©der √† toutes les fonctionnalit√©s avanc√©es !
      </p>
      <div style="display:flex; flex-direction:column; gap:12px;">
        <a href="pricing.html" style="display:block; padding:16px 32px; background:linear-gradient(135deg,#6366f1,#a855f7,#ec4899); color:#fff; font-weight:700; font-size:16px; border-radius:999px; text-decoration:none; box-shadow:0 20px 50px rgba(99,102,241,.35);">
          ‚ö° Voir les offres Pro
        </a>
        <button onclick="closeUpgradeModal()" style="padding:14px 28px; background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.14); color:rgba(255,255,255,.8); font-size:14px; border-radius:999px; cursor:pointer;">
          Plus tard
        </button>
      </div>
      <p style="margin-top:20px; font-size:12px; color:rgba(255,255,255,.5);">
        üí° √Ä partir de 7 990 XPF/mois
      </p>
    </div>
  </div>

  <script>
    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyCKPepYjXiY92hZPEdKxqOow9AACfMTOoc",
      authDomain: "neorastudiosnc.firebaseapp.com",
      projectId: "neorastudiosnc",
      storageBucket: "neorastudiosnc.firebasestorage.app",
      messagingSenderId: "275455765566",
      appId: "1:275455765566:web:c2cf516fcb8f13de7e356f"
    };
    
    // Initialiser Firebase
    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
    
    const auth = firebase.auth();
    const db = firebase.firestore();
    
    // Fonction pour cr√©er ou mettre √† jour le document utilisateur
    async function ensureUserDocument(user) {
      if (!user) return;
      
      const userRef = db.collection('users').doc(user.uid);
      const userDoc = await userRef.get();
      
      if (!userDoc.exists) {
        // Nouveau utilisateur FREE ‚Üí 5 cr√©dits gratuits √† vie
        await userRef.set({
          email: user.email,
          firstName: '',
          lastName: '',
          avatarUrl: user.photoURL || '',
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          lastLoginAt: firebase.firestore.FieldValue.serverTimestamp(),
          blocked: false,
          provider: user.providerData[0]?.providerId || 'email',
          plan: 'free',
          generationsAvailable: 5, // 5 cr√©dits gratuits pour les FREE
          lastBonusMonth: '',
          totalGenerations: 0,
          monthlyGenerations: 0,
          lastGenerationMonth: ''
        });
        
        // Envoyer l'email de bienvenue
        sendWelcomeEmail(user.email);
      } else {
        // Utilisateur existant ‚Üí mettre √† jour lastLoginAt
        await userRef.update({
          lastLoginAt: firebase.firestore.FieldValue.serverTimestamp()
        });
      }
    }
    
    // Fonction pour envoyer l'email de bienvenue via n8n
    async function sendWelcomeEmail(email) {
      const WELCOME_WEBHOOK_URL = 'https://n8n.srv1125399.hstgr.cloud/webhook/welcome-email';
      
      try {
        await fetch(WELCOME_WEBHOOK_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            email: email,
            firstName: email.split('@')[0]
          })
        });
        console.log('‚úÖ Email de bienvenue envoy√© √†', email);
      } catch (error) {
        console.error('‚ùå Erreur envoi email bienvenue:', error);
      }
    }
    
    // Modal Upgrade
    function showUpgradeModal() {
      document.getElementById('upgradeModal').style.display = 'flex';
    }
    
    function closeUpgradeModal() {
      document.getElementById('upgradeModal').style.display = 'none';
    }
    
    // D√©duire un cr√©dit apr√®s g√©n√©ration r√©ussie
    async function deductCredit() {
      const user = auth.currentUser;
      if (!user) return;
      
      try {
        const userRef = db.collection('users').doc(user.uid);
        await userRef.update({
          generationsAvailable: firebase.firestore.FieldValue.increment(-1),
          lastGenerationAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        console.log('‚úÖ Cr√©dit d√©duit');
        
        // Mettre √† jour le compteur affich√©
        const currentCount = parseInt(document.getElementById('creditsCount').textContent) || 0;
        updateCreditsDisplay(Math.max(0, currentCount - 1));
      } catch (error) {
        console.error('Erreur d√©duction cr√©dit:', error);
      }
    }
    
    // Rembourser un cr√©dit en cas d'√©chec
    async function refundCredit() {
      const user = auth.currentUser;
      if (!user) return;
      
      try {
        const userRef = db.collection('users').doc(user.uid);
        await userRef.update({
          generationsAvailable: firebase.firestore.FieldValue.increment(1)
        });
        console.log('üîÑ Cr√©dit rembours√©');
        
        // Mettre √† jour le compteur affich√©
        const currentCount = parseInt(document.getElementById('creditsCount').textContent) || 0;
        updateCreditsDisplay(currentCount + 1);
      } catch (error) {
        console.error('Erreur remboursement cr√©dit:', error);
      }
    }
    
    // Fonction pour v√©rifier si l'utilisateur est bloqu√©
    async function checkIfBlocked(user) {
      if (!user) return false;
      
      const userDoc = await db.collection('users').doc(user.uid).get();
      if (userDoc.exists && userDoc.data().blocked === true) {
        alert('Votre compte a √©t√© suspendu. Contactez le support pour plus d\'informations.');
        auth.signOut();
        window.location.href = 'index.html';
        return true;
      }
      return false;
    }
    
    // Protection: V√©rifier si l'utilisateur est connect√© et non bloqu√©
    auth.onAuthStateChanged(async (user) => {
      if (!user) {
        window.location.href = 'index.html';
        return;
      }
      
      // Cr√©er/mettre √† jour le document utilisateur
      await ensureUserDocument(user);
      
      // V√©rifier si bloqu√©
      await checkIfBlocked(user);
      
      // Charger et afficher les cr√©dits
      await loadCredits(user);
    });
    
    // Fonction pour charger et afficher les cr√©dits
    async function loadCredits(user) {
      if (!user) return;
      
      try {
        const userDoc = await db.collection('users').doc(user.uid).get();
        const userData = userDoc.exists ? userDoc.data() : {};
        const credits = userData.generationsAvailable || 0;
        
        updateCreditsDisplay(credits);
      } catch (error) {
        console.error('Erreur chargement cr√©dits:', error);
      }
    }
    
    // Fonction pour mettre √† jour l'affichage des cr√©dits
    function updateCreditsDisplay(credits) {
      const counter = document.getElementById('creditsCounter');
      const countEl = document.getElementById('creditsCount');
      
      if (!counter || !countEl) return;
      
      countEl.textContent = credits;
      
      // Changer le style selon le nombre de cr√©dits
      counter.classList.remove('low', 'empty');
      if (credits === 0) {
        counter.classList.add('empty');
      } else if (credits <= 2) {
        counter.classList.add('low');
      }
    }
    
    // Initialisation du tracker NEORA
    initNeoraTracker('NEORASIMPLE');
    
    const CLOUDINARY_UPLOAD_URL = "https://api.cloudinary.com/v1_1/diegfxcyl/image/upload";
    const CLOUDINARY_UPLOAD_PRESET = "neora_upload";

    const N8N_GENERATE_URL = "https://n8n.srv1125399.hstgr.cloud/webhook/9c487157-bdc1-4d40-9a47-4027ebf817a5";
    const N8N_STATUS_URL = ""; // optionnel

    const $ = (id) => document.getElementById(id);

    const promptEl = $("prompt_user");
    const fileInput = $("product_image");
    const aspectEl = $("aspectRatio");

    const statusEl = $("status");
    const submitBtn = $("submit-btn");
    const recheckBtn = $("recheck-btn");
    const resetBtn = $("reset-btn");

    const empty = $("empty");
    const img = $("preview-image");
    const overlay = $("overlay");
    const overlayText = $("overlayText");

    const modeEl = $("mode");
    const taskPill = $("taskPill");
    const taskIdEl = $("taskId");

    const downloadLink = $("downloadLink");

    const dropZone = $("dropZone");
    const browseBtn = $("browseBtn");
    const clearBtn = $("clearBtn");
    const fileTitle = $("fileTitle");
    const fileSub = $("fileSub");

    const FIXED_RESOLUTION = "2K";

    let lastTaskId = null;
    let pollTimer = null;

    function setStatus(msg){ statusEl.textContent = msg || ""; }

    function setOverlay(show, text){
      overlayText.textContent = text || "Generating‚Ä¶";
      overlay.style.display = show ? "flex" : "none";
    }
    function stopPolling(){ if(pollTimer) clearInterval(pollTimer); pollTimer = null; }

    function setModeFromImage(imageUrl){
      modeEl.textContent = imageUrl ? "image-to-image" : "text-to-image";
    }

    function setTask(taskId){
      lastTaskId = taskId || null;
      if(lastTaskId){
        taskPill.style.display = "inline-flex";
        taskIdEl.textContent = lastTaskId;
        recheckBtn.disabled = false;
      } else {
        taskPill.style.display = "none";
        taskIdEl.textContent = "";
        recheckBtn.disabled = true;
      }
    }

    function showImage(url){
      empty.style.display = "none";
      img.style.display = "block";
      img.src = url;

      downloadLink.href = url;
      downloadLink.style.display = "inline-block";
    }

    function clearResult(){
      img.style.display = "none";
      img.src = "";
      empty.style.display = "block";
      downloadLink.style.display = "none";
      downloadLink.href = "#";
    }

    function normalizeResponse(data){
      const image =
        data?.resultImageUrl ||
        data?.image_url ||
        data?.myField ||
        data?.data?.response?.resultImageUrl ||
        data?.data?.info?.resultImageUrl ||
        "";

      const taskId =
        data?.taskId ||
        data?.data?.taskId ||
        data?.data?.response?.taskId ||
        "";

      const successFlag =
        data?.successFlag ??
        data?.data?.successFlag ??
        null;

      let status = data?.status || "";
      if (!status) {
        if (image) status = "done";
        else if (successFlag == 2 || successFlag == "2" || successFlag == 3 || successFlag == "3") status = "failed";
        else status = "processing";
      }

      const errorMessage = data?.errorMessage || data?.data?.errorMessage || data?.message || "";
      return { status, image, taskId, successFlag, errorMessage };
    }

    async function uploadToCloudinary(file){
      const fd = new FormData();
      fd.append("file", file);
      fd.append("upload_preset", CLOUDINARY_UPLOAD_PRESET);

      const res = await fetch(CLOUDINARY_UPLOAD_URL, { method:"POST", body: fd });
      if(!res.ok) throw new Error("Cloudinary upload failed");
      const json = await res.json();
      if(!json.secure_url) throw new Error("Cloudinary: missing secure_url");
      return json.secure_url;
    }

    async function postJson(url, payload){
      const res = await fetch(url, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify(payload)
      });

      if(!res.ok){
        const txt = await res.text().catch(()=> "");
        throw new Error("n8n error: " + (txt || res.status));
      }
      return await res.json();
    }

    async function callGenerate(payload){
      return postJson(N8N_GENERATE_URL, payload);
    }

    async function callStatus(taskId, forceUrl){
      const statusUrl = forceUrl || N8N_STATUS_URL;
      if(!statusUrl) throw new Error("STATUS_URL not configured");

      const url = statusUrl.includes("?")
        ? `${statusUrl}&taskId=${encodeURIComponent(taskId)}`
        : `${statusUrl}?taskId=${encodeURIComponent(taskId)}`;

      const res = await fetch(url, { method:"GET" });
      if(!res.ok) throw new Error("status error: " + res.status);
      return await res.json();
    }

    function startPolling(taskId, { statusUrlOverride = "" } = {}){
      const statusUrl = statusUrlOverride || N8N_STATUS_URL;
      if(!statusUrl) return;

      stopPolling();
      pollTimer = setInterval(async () => {
        try{
          const data = await callStatus(taskId, statusUrl);
          const r = normalizeResponse(data);

          if(r.status === "done" && r.image){
            stopPolling();
            setOverlay(false);
            setStatus("Done ‚úÖ");
            showImage(r.image);
            // Note: cr√©dit d√©j√† d√©duit dans submitBtn, pas besoin ici
          } else if(r.status === "failed"){
            stopPolling();
            setOverlay(false);
            setStatus("Failed ‚ùå " + (r.errorMessage || ""));
          } else {
            setStatus("Processing‚Ä¶ (polling)");
          }
        } catch(e){
          setStatus("Polling: " + (e.message || e));
        }
      }, 2000);
    }

    function updateFileUI(file){
      if(!file){
        fileTitle.textContent = "Drop image here (or browse)";
        fileSub.textContent = "PNG / JPG ‚Ä¢ optional";
        return;
      }
      fileTitle.textContent = file.name;
      fileSub.textContent = `${Math.round(file.size/1024)} KB ‚Ä¢ ready`;
    }

    browseBtn.addEventListener("click", () => fileInput.click());
    clearBtn.addEventListener("click", () => {
      fileInput.value = "";
      updateFileUI(null);
      setModeFromImage("");
      setStatus("Image cleared.");
    });

    fileInput.addEventListener("change", () => {
      const f = fileInput.files?.[0] || null;
      updateFileUI(f);
      if(f){
        setModeFromImage("x");
        const url = URL.createObjectURL(f);
        clearResult();
        // preview only
        showImage(url);
        setStatus("Image ready (optional).");
      } else {
        setModeFromImage("");
      }
    });

    ;["dragenter","dragover"].forEach(evt => {
      dropZone.addEventListener(evt, (e) => {
        e.preventDefault();
        dropZone.style.borderColor = "rgba(99,102,241,.55)";
        dropZone.style.background = "rgba(0,0,0,.30)";
      });
    });
    ;["dragleave","drop"].forEach(evt => {
      dropZone.addEventListener(evt, (e) => {
        e.preventDefault();
        dropZone.style.borderColor = "rgba(255,255,255,.20)";
        dropZone.style.background = "rgba(0,0,0,.22)";
      });
    });
    dropZone.addEventListener("drop", (e) => {
      const f = e.dataTransfer.files?.[0];
      if(!f) return;
      fileInput.files = e.dataTransfer.files;
      updateFileUI(f);
      setModeFromImage("x");
      const url = URL.createObjectURL(f);
      clearResult();
      // preview only
      showImage(url);
      setStatus("Image ready (optional).");
    });

    submitBtn.addEventListener("click", async () => {
      stopPolling();
      setStatus("");
      setTask(null);

      const prompt = (promptEl.value || "").trim();
      if(!prompt){
        setStatus("Write a prompt first.");
        return;
      }

      // === V√âRIFICATION DES CR√âDITS ===
      const user = auth.currentUser;
      if (!user) {
        setStatus("Connectez-vous pour g√©n√©rer.");
        return;
      }
      
      const userDoc = await db.collection('users').doc(user.uid).get();
      const userData = userDoc.exists ? userDoc.data() : {};
      const credits = userData.generationsAvailable || 0;
      const plan = userData.plan || 'free';
      
      if (credits <= 0) {
        setOverlay(false);
        if (plan === 'free') {
          setStatus("‚ùå Vous avez utilis√© vos 5 g√©n√©rations gratuites.");
          showUpgradeModal();
        } else {
          setStatus("‚ùå Plus de cr√©dits disponibles. Achetez un pack de cr√©dits.");
          window.location.href = 'pricing.html';
        }
        return;
      }
      // === FIN V√âRIFICATION ===

      submitBtn.disabled = true;
      recheckBtn.disabled = true;

      // === D√âDUIRE LE CR√âDIT IMM√âDIATEMENT ===
      let creditDeducted = false;
      try {
        await deductCredit();
        creditDeducted = true;
      } catch (e) {
        console.error('Erreur d√©duction cr√©dit:', e);
      }

      setOverlay(true, "Generating‚Ä¶");
      setStatus("Processing‚Ä¶");
      clearResult();

      try{
        const aspectRatio = aspectEl.value;
        const file = fileInput.files?.[0] || null;
        let image_url = "";

        if(file){
          setOverlay(true, "Uploading image‚Ä¶");
          image_url = await uploadToCloudinary(file);
        }

        setModeFromImage(image_url);

        const payload = {
          prompt_user: prompt,
          resolution: FIXED_RESOLUTION,
          aspectRatio
        };
        if(image_url) payload.image_url = image_url;

        const data = await callGenerate(payload);
        const r = normalizeResponse(data);

        if(r.taskId) setTask(r.taskId);

        if(r.status === "done" && r.image){
          setOverlay(false);
          setStatus("Done ‚úÖ");
          showImage(r.image);
          
          // Sauvegarde dans l'historique
          saveGeneration({
            imageUrl: r.image,
            prompt: prompt,
            aspectRatio: aspectRatio,
            mode: image_url ? 'image-to-image' : 'text-to-image'
          });
        } else if(r.status === "failed"){
          setOverlay(false);
          setStatus("Failed ‚ùå " + (r.errorMessage || ""));
          // Rembourser le cr√©dit si √©chec
          if (creditDeducted) {
            await refundCredit();
          }
        } else {
          setStatus("Processing‚Ä¶ (not ready on first check)");
          if(r.taskId && N8N_STATUS_URL) startPolling(r.taskId);
        }

      } catch(e){
        setOverlay(false);
        setStatus("Error: " + (e.message || e));
        // Rembourser le cr√©dit si erreur
        if (creditDeducted) {
          await refundCredit();
        }
      } finally {
        submitBtn.disabled = false;
      }
    });

    recheckBtn.addEventListener("click", async () => {
      if(!lastTaskId){
        setStatus("No taskId.");
        return;
      }
      if(!N8N_STATUS_URL){
        setStatus("Re-check unavailable: add a /status endpoint in n8n (record-info GET).");
        return;
      }

      try{
        setOverlay(true, "Checking‚Ä¶");
        setStatus("Re-check‚Ä¶");
        const data = await callStatus(lastTaskId, N8N_STATUS_URL);
        const r = normalizeResponse(data);

        if(r.status === "done" && r.image){
          setOverlay(false);
          setStatus("Done ‚úÖ");
          showImage(r.image);
        } else if(r.status === "failed"){
          setOverlay(false);
          setStatus("Failed ‚ùå " + (r.errorMessage || ""));
        } else {
          setOverlay(true, "Still processing‚Ä¶");
          setStatus("Still processing‚Ä¶");
          startPolling(lastTaskId);
        }
      } catch(e){
        setOverlay(false);
        setStatus("Re-check error: " + (e.message || e));
      }
    });

    resetBtn.addEventListener("click", () => {
      stopPolling();
      promptEl.value = "";
      fileInput.value = "";
      updateFileUI(null);
      setModeFromImage("");
      setTask(null);
      clearResult();
      setOverlay(false);
      setStatus("Ready.");
    });

    setStatus("Ready.");
    updateFileUI(null);
    setModeFromImage("");
    
    function logout() {
      if (typeof NeoraAuth !== "undefined") NeoraAuth.clear();
      auth.signOut().then(() => {
        window.location.href = 'index.html';
      });
    }
  </script>
<script src="neora-templates.js"></script>
<script src="neora-cache.js"></script>
<script src="neora-mobile-nav.js"></script>
</body>
</html>
