<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NEORA PRO</title>
  
  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <script src="neora-tracker.js"></script>
  
  <style>
    :root{
      --bg0:#050714;
      --bg1:#070a1a;

      /* panels glass */
      --card: rgba(255,255,255,.035);
      --border: rgba(255,255,255,.11);

      /* text */
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.70);
      --muted2: rgba(255,255,255,.56);

      --shadow2: 0 18px 60px rgba(0,0,0,.55);
      --radius:18px;
      --focus: 0 0 0 4px rgba(99,102,241,.22);
      --grad: linear-gradient(135deg,#6366f1,#ec4899 45%,#22d3ee);

      /* input glass */
      --field-bg: rgba(0,0,0,.32);
      --field-border: rgba(255,255,255,.16);
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      color:var(--text);
      background:
        radial-gradient(1200px 600px at 20% 0%, rgba(99,102,241,.22), transparent 60%),
        radial-gradient(900px 500px at 80% 10%, rgba(236,72,153,.18), transparent 55%),
        radial-gradient(900px 700px at 50% 110%, rgba(34,211,238,.12), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow-x:hidden;
    }

    /* Topbar */
    .topbar{
      position:sticky; top:0; z-index:10;
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      background: linear-gradient(180deg, rgba(5,7,20,.76), rgba(5,7,20,.48));
      border-bottom: 1px solid rgba(255,255,255,.08);
    }
    .topbar-inner{
      max-width:1100px;
      margin:0 auto;
      padding:16px 20px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:14px;
    }
    .brand{ display:flex; align-items:center; gap:12px; user-select:none; }
    .logo{
      width:34px; height:34px; border-radius:10px;
      background: var(--grad);
      box-shadow: 0 14px 40px rgba(99,102,241,.22);
      position:relative;
    }
    .logo:after{
      content:"";
      position:absolute; inset:1px;
      border-radius:9px;
      background: linear-gradient(180deg, rgba(0,0,0,.18), rgba(255,255,255,.08));
      mix-blend-mode: overlay;
    }
    .brand h1{
      margin:0;
      font-size:15px;
      letter-spacing:.35em;
      text-transform:uppercase;
      line-height:1;
      color: rgba(255,255,255,.95);
    }
    .badge{
      font-size:12px;
      color: rgba(255,255,255,.78);
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.045);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      box-shadow: 0 10px 30px rgba(0,0,0,.22);
      white-space:nowrap;
    }
    
    /* Navigation */
    .nav-links {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .nav-link {
      padding: 8px 14px;
      border-radius: 999px;
      font-size: 13px;
      font-weight: 500;
      text-decoration: none;
      color: rgba(255,255,255,.7);
      transition: all 0.2s;
    }
    .nav-link:hover {
      color: rgba(255,255,255,.95);
      background: rgba(255,255,255,.08);
    }
    .topbar-right {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    @media (max-width: 600px) {
      .nav-links { display: none; }
    }

    /* Layout */
    .wrap{
      max-width:1100px;
      margin: 0 auto;
      padding: 22px 20px 34px;
    }
    .grid{
      display:grid;
      grid-template-columns: 420px 1fr;
      gap:16px;
      align-items:start;
    }
    @media (max-width: 980px){
      .grid{ grid-template-columns:1fr; }
    }

    .panel{
      background: linear-gradient(180deg, var(--card), rgba(255,255,255,.02));
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow2);
      overflow:hidden;
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
    }
    .panel .head{
      padding:18px 18px 14px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
    }
    .title{
      margin:0;
      font-size:16px;
      letter-spacing:.02em;
      color: rgba(255,255,255,.92);
    }
    .subtitle{
      margin:6px 0 0;
      font-size:13px;
      color: var(--muted);
      line-height:1.4;
    }
    .panel .body{ padding:16px 18px 18px; }

    label{
      display:block;
      font-size:12px;
      color: var(--muted);
      margin: 12px 0 6px;
      letter-spacing:.02em;
    }

    textarea, select, input[type="text"], input[type="email"], input[type="tel"], input[type="number"]{
      width:100%;
      border-radius: 14px;
      border:1px solid var(--field-border);
      background: var(--field-bg);
      color: rgba(255,255,255,.95);
      padding: 12px 12px;
      outline:none;
      transition: border .15s ease, box-shadow .15s ease, background .15s ease;
      box-shadow: 0 10px 30px rgba(0,0,0,.22);
    }
    textarea{
      min-height: 140px;
      resize: vertical;
    }
    textarea:focus, select:focus, input:focus{
      border-color: rgba(99,102,241,.62);
      box-shadow: var(--focus), 0 12px 34px rgba(0,0,0,.30);
      background: rgba(0,0,0,.38);
    }

    .row2{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
    }
    @media (max-width: 520px){
      .row2{ grid-template-columns:1fr; }
    }

    /* Upload */
    .drop{
      border-radius: 16px;
      border: 1px dashed rgba(255,255,255,.20);
      background: rgba(0,0,0,.22);
      padding: 14px;
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:space-between;
      transition: border .15s ease, background .15s ease;
      box-shadow: 0 10px 30px rgba(0,0,0,.18);
    }
    .drop:hover{
      border-color: rgba(99,102,241,.45);
      background: rgba(0,0,0,.28);
    }
    .drop-left{ display:flex; gap:12px; align-items:center; min-width:0; }
    .upload-ico{
      width:38px; height:38px;
      border-radius: 14px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
      display:grid; place-items:center;
      flex:0 0 auto;
    }
    .drop-meta{ min-width:0; }
    .drop-title{
      font-size:13px; margin:0; color: rgba(255,255,255,.90);
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .drop-sub{
      margin:4px 0 0; font-size:12px; color: var(--muted2);
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .drop-actions{ display:flex; gap:8px; align-items:center; flex:0 0 auto; }

    .btn-small{
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.92);
      padding: 9px 10px;
      border-radius: 999px;
      cursor:pointer;
      transition: transform .12s ease, background .12s ease, border .12s ease;
      font-weight:900;
      font-size:12px;
    }
    .btn-small:hover{ transform: translateY(-1px); background: rgba(255,255,255,.09); }
    .btn-small:active{ transform: translateY(0px); }

    input[type="file"]{ display:none; }

    /* Buttons */
    .btnrow{
      display:flex; gap:10px; margin-top:14px; flex-wrap:wrap;
    }
    .btn{
      flex:1 1 auto;
      border-radius: 999px;
      padding: 12px 14px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.94);
      cursor:pointer;
      font-weight:900;
      letter-spacing:.02em;
      transition: transform .12s ease, background .12s ease, box-shadow .12s ease;
      box-shadow: 0 12px 34px rgba(0,0,0,.28);
    }
    .btn:hover{ transform: translateY(-1px); background: rgba(255,255,255,.09); }
    .btn:active{ transform: translateY(0px); }
    .btn:disabled{ opacity:.55; cursor:not-allowed; transform:none; }

    .btn-primary{
      border:none;
      background: var(--grad);
      color:#fff;
      box-shadow: 0 18px 45px rgba(99,102,241,.22);
    }

    .status{
      margin-top:12px;
      font-size:12.5px;
      color: rgba(255,255,255,.72);
      min-height: 1.2em;
      white-space: pre-wrap;
    }

    /* Preview */
    .preview-head{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
    }
    .hint{
      font-size:12px;
      color: var(--muted);
      margin-top:6px;
      line-height:1.45;
    }
    .frame{
      margin-top:14px;
      border-radius: var(--radius);
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.22);
      overflow:hidden;
      position:relative;
      min-height: 320px;
      display:grid;
      place-items:center;
      box-shadow: 0 18px 60px rgba(0,0,0,.38);
    }
    .frame img{
      width:100%;
      height:100%;
      object-fit:contain;
      display:block;
      max-height: 660px;
    }
    .empty{
      padding: 34px 18px;
      text-align:center;
      color: rgba(255,255,255,.65);
      font-size:13px;
      line-height:1.55;
    }
    .empty strong{
      color: rgba(255,255,255,.92);
      font-weight:900;
    }
    .overlay{
      position:absolute; inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      background: rgba(5,7,20,.62);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
    }
    .overlay-inner{
      display:flex; align-items:center; gap:12px;
      padding: 12px 14px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.94);
      box-shadow: 0 18px 60px rgba(0,0,0,.35);
      font-weight:900;
      font-size:13px;
    }
    .spin{
      width:18px; height:18px;
      border-radius:999px;
      border: 3px solid rgba(255,255,255,.24);
      border-top-color: rgba(255,255,255,.95);
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin{ to{ transform: rotate(360deg);} }

    .meta{
      margin-top:10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      color: var(--muted2);
      font-size:12px;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 7px 10px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }

    .link{
      color: rgba(255,255,255,.92);
      text-decoration:none;
      font-weight:900;
      border-bottom:1px solid rgba(255,255,255,.22);
      padding-bottom:2px;
    }
    .link:hover{ opacity:.92; }

    /* ‚úÖ Aspect ratio dropdown */
    #aspectRatio{
      height: 42px !important;
      padding: 8px 38px 8px 12px !important;
      font-size: 13px !important;
      font-weight: 900 !important;
      border-radius: 12px !important;

      background: rgba(255,255,255,.10) !important;
      border: 1px solid rgba(255,255,255,.22) !important;
      color: rgba(255,255,255,.98) !important;

      box-shadow: 0 10px 26px rgba(0,0,0,.22) !important;

      appearance: none;
      -webkit-appearance: none;
      -moz-appearance: none;

      background-image:
        linear-gradient(45deg, transparent 50%, rgba(255,255,255,.95) 50%),
        linear-gradient(135deg, rgba(255,255,255,.95) 50%, transparent 50%);
      background-position:
        calc(100% - 16px) 50%,
        calc(100% - 11px) 50%;
      background-size: 5px 5px, 5px 5px;
      background-repeat: no-repeat;
    }
    #aspectRatio:hover{
      border-color: rgba(99,102,241,.55) !important;
      background: rgba(255,255,255,.13) !important;
    }
    #aspectRatio:focus{
      border-color: rgba(99,102,241,.75) !important;
      box-shadow: 0 0 0 4px rgba(99,102,241,.26), 0 10px 26px rgba(0,0,0,.22) !important;
    }
    #aspectRatio option{
      background: #0b1026 !important;
      color: rgba(255,255,255,.95) !important;
      font-weight: 800 !important;
    }

    /* ‚úÖ NEW: edit section */
    .editbox{
      margin-top:14px;
      padding:14px;
      border-radius: var(--radius);
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.20);
      box-shadow: 0 18px 60px rgba(0,0,0,.22);
    }
    .edit-hint{
      margin:6px 0 0;
      font-size:12px;
      color: var(--muted);
      line-height:1.45;
    }
    .edit-status{
      margin-top:10px;
      font-size:12.5px;
      color: rgba(255,255,255,.72);
      min-height: 1.2em;
      white-space: pre-wrap;
    }
  </style>
</head>

<body>
  <div class="topbar">
    <div class="topbar-inner">
      <div class="brand">
        <div class="logo"></div>
        <div>
          <h1>NEORA</h1>
          <div style="font-size:12px;color:rgba(255,255,255,.70);margin-top:4px;">G√©n√©rateur d'image</div>
        </div>
      </div>
      <div class="topbar-right">
        <div class="nav-links">
          <a href="index.html" class="nav-link">üè† Accueil</a>
          <a href="profil.html" class="nav-link">üë§ Profil</a>
          <a href="historique.html" class="nav-link">üìÅ Historique</a>
        </div>
        <div class="badge">Pro</div>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="grid">
      <!-- Controls -->
      <div class="panel">
        <div class="head">
          <h2 class="title">Create</h2>
          <p class="subtitle">D√©cris ce que tu veux. Ajoute 1 ou plusieurs images si tu veux transformer / r√©f√©rencer.</p>
        </div>
        <div class="body">

          <div class="row2">
            <div>
              <label for="product_name">Nom du produit</label>
              <input id="product_name" type="text" placeholder="Ex: Nike TN" />
            </div>
            <div>
              <label for="product_price">Prix</label>
              <input id="product_price" type="number" inputmode="decimal" min="0" step="0.01" placeholder="Ex: 129.99" />
            </div>
          </div>

          <div class="row2">
            <div>
              <label for="user_email">Email</label>
              <input id="user_email" type="email" placeholder="ex: client@email.com" />
            </div>
            <div>
              <label for="user_phone">T√©l√©phone</label>
              <input id="user_phone" type="tel" placeholder="ex: +687 12 34 56" />
            </div>
          </div>

          <label for="prompt_user">Prompt</label>
          <textarea id="prompt_user" placeholder="Ex: Cr√©er une publicit√© vibe Nike splash.."></textarea>

          <label>Images (optionnel) ‚Äî multi</label>
          <div class="drop" id="dropZone">
            <div class="drop-left">
              <div class="upload-ico">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                  <path d="M12 16V4m0 0l-4 4m4-4l4 4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  <path d="M4 16v2a2 2 0 002 2h12a2 2 0 002-2v-2" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
              </div>
              <div class="drop-meta">
                <p class="drop-title" id="fileTitle">Drop images here (or browse)</p>
                <p class="drop-sub" id="fileSub">PNG / JPG ‚Ä¢ up to 8 ‚Ä¢ optional</p>
              </div>
            </div>
            <div class="drop-actions">
              <button type="button" class="btn-small" id="browseBtn">Browse</button>
              <button type="button" class="btn-small" id="clearBtn">Clear</button>
            </div>

            <!-- ‚úÖ MULTI -->
            <input type="file" id="product_image" accept="image/*" multiple />
          </div>

          <div class="row2" style="margin-top:12px;">
            <div>
              <label>Resolution</label>
              <div class="pill"><span class="mono">2K</span></div>
            </div>
            <div>
              <label for="aspectRatio">Aspect ratio</label>
              <select id="aspectRatio">
                <option value="16:9" selected>16:9</option>
                <option value="1:1">1:1</option>
                <option value="4:5">4:5</option>
                <option value="9:16">9:16</option>
                <option value="auto">auto</option>
              </select>
            </div>
          </div>

          <div class="btnrow">
            <button class="btn btn-primary" id="submit-btn">Generate</button>
            <button class="btn" id="recheck-btn" disabled>Re-check</button>
            <button class="btn" id="reset-btn">Reset</button>
          </div>

          <div class="status" id="status">Ready.</div>
        </div>
      </div>

      <!-- Preview -->
      <div class="panel">
        <div class="head">
          <div class="preview-head">
            <div>
              <h2 class="title">Result</h2>
              <div class="hint">Ton image finale s‚Äôaffiche ici.</div>
            </div>
            <a class="link" id="downloadLink" href="#" target="_blank" rel="noreferrer" style="display:none;">Download</a>
          </div>
        </div>

        <div class="body">
          <div class="frame" id="frame">
            <div class="empty" id="empty">
              <div style="font-size:14px;margin-bottom:8px;"><strong>No output yet</strong></div>
              <div>√âcris un prompt, ajoute des images si besoin, puis clique <b>Generate</b>.</div>
            </div>
            <img id="preview-image" alt="Neora result" style="display:none;" />
            <div class="overlay" id="overlay">
              <div class="overlay-inner">
                <span class="spin"></span>
                <span id="overlayText">Generating‚Ä¶</span>
              </div>
            </div>
          </div>

          <div class="meta">
            <span class="pill">Mode: <span id="mode" class="mono">text-to-image</span></span>
            <span class="pill" id="taskPill" style="display:none;">Task: <span id="taskId" class="mono"></span></span>
          </div>

          <!-- Modifications -->
          <div class="editbox" id="editSection" style="display:none;">
            <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;">
              <div style="font-weight:900;">Modifications</div>
              <div class="pill">Base: <span id="editBase" class="mono">‚Äî</span></div>
            </div>
            <div class="edit-hint">D√©cris uniquement ce que tu veux changer.</div>

            <label for="editPrompt" style="margin-top:12px;">Instruction de modification</label>
            <textarea id="editPrompt" placeholder="Ex: assombrir le fond, ajouter un glow bleu derri√®re le produit, typo plus minimaliste..."></textarea>

            <div class="btnrow" style="margin-top:12px;">
              <button class="btn btn-primary" id="applyEditBtn">Apply changes</button>
              <button class="btn" id="clearEditBtn">Clear</button>
            </div>

            <div class="edit-status" id="editStatus"></div>
          </div>

        </div>
      </div>
    </div>
  </div>

  <script>
    // Initialisation du tracker NEORA
    initNeoraTracker('NEORAPRO');
    
    const CLOUDINARY_UPLOAD_URL = "https://api.cloudinary.com/v1_1/diegfxcyl/image/upload";
    const CLOUDINARY_UPLOAD_PRESET = "neora_upload";

    const N8N_GENERATE_URL = "https://n8n.srv1125399.hstgr.cloud/webhook/0ea355a8-bffe-4202-9434-fce703f987e4";
    const N8N_EDIT_URL = "";

    const $ = (id) => document.getElementById(id);

    const productNameEl = $("product_name");
    const productPriceEl = $("product_price");
    const emailEl = $("user_email");
    const phoneEl = $("user_phone");

    const promptEl = $("prompt_user");
    const fileInput = $("product_image");
    const aspectEl = $("aspectRatio");

    const statusEl = $("status");
    const submitBtn = $("submit-btn");
    const recheckBtn = $("recheck-btn");
    const resetBtn = $("reset-btn");

    const empty = $("empty");
    const img = $("preview-image");
    const overlay = $("overlay");
    const overlayText = $("overlayText");

    const modeEl = $("mode");
    const taskPill = $("taskPill");
    const taskIdEl = $("taskId");

    const downloadLink = $("downloadLink");

    const dropZone = $("dropZone");
    const browseBtn = $("browseBtn");
    const clearBtn = $("clearBtn");
    const fileTitle = $("fileTitle");
    const fileSub = $("fileSub");

    // Edit UI
    const editSection = $("editSection");
    const editPromptEl = $("editPrompt");
    const applyEditBtn = $("applyEditBtn");
    const clearEditBtn = $("clearEditBtn");
    const editStatusEl = $("editStatus");
    const editBaseEl = $("editBase");

    const FIXED_RESOLUTION = "2K";
    const MAX_UPLOAD_IMAGES = 8; // ‚úÖ MULTI (limite front)

    let lastTaskId = null;
    let pollTimer = null;

    // keep last GENERATED image
    let lastGeneratedUrl = "";

    function setStatus(msg){ statusEl.textContent = msg || ""; }
    function setEditStatus(msg){ editStatusEl.textContent = msg || ""; }

    function setOverlay(show, text){
      overlayText.textContent = text || "Generating‚Ä¶";
      overlay.style.display = show ? "flex" : "none";
    }
    function stopPolling(){ if(pollTimer) clearInterval(pollTimer); pollTimer = null; }

    function setModeFromCount(count){
      modeEl.textContent = count > 0 ? "image-to-image" : "text-to-image";
    }

    function setTask(taskId){
      lastTaskId = taskId || null;
      if(lastTaskId){
        taskPill.style.display = "inline-flex";
        taskIdEl.textContent = lastTaskId;
        recheckBtn.disabled = false;
      } else {
        taskPill.style.display = "none";
        taskIdEl.textContent = "";
        recheckBtn.disabled = true;
      }
    }

    function showEditSection(show){
      editSection.style.display = show ? "block" : "none";
      if(!show){
        editPromptEl.value = "";
        setEditStatus("");
        editBaseEl.textContent = "‚Äî";
      }
    }

    function setResult(url, { generated = true } = {}){
      empty.style.display = "none";
      img.style.display = "block";
      img.src = url;

      if(generated){
        lastGeneratedUrl = url;
        downloadLink.href = url;
        downloadLink.style.display = "inline-block";

        showEditSection(true);
        editBaseEl.textContent = "generated";
        setEditStatus("Pr√™t √† modifier ‚úÖ");
      } else {
        downloadLink.style.display = "none";
        showEditSection(false);
      }
    }

    function clearResult(){
      img.style.display = "none";
      img.src = "";
      empty.style.display = "block";
      downloadLink.style.display = "none";
      downloadLink.href = "#";
      lastGeneratedUrl = "";
      showEditSection(false);
    }

    function normalizeResponse(data){
      const image =
        data?.resultImageUrl ||
        data?.image_url ||
        data?.result_url ||
        data?.myField ||
        data?.data?.response?.resultImageUrl ||
        data?.data?.info?.resultImageUrl ||
        "";

      const taskId =
        data?.taskId ||
        data?.data?.taskId ||
        data?.data?.response?.taskId ||
        "";

      const successFlag =
        data?.successFlag ??
        data?.data?.successFlag ??
        null;

      let status = data?.status || "";
      if (!status) {
        if (image) status = "done";
        else if (successFlag == 2 || successFlag == "2" || successFlag == 3 || successFlag == "3") status = "failed";
        else status = "processing";
      }

      const errorMessage = data?.errorMessage || data?.data?.errorMessage || data?.message || "";
      return { status, image, taskId, successFlag, errorMessage };
    }

    async function uploadToCloudinary(file){
      const fd = new FormData();
      fd.append("file", file);
      fd.append("upload_preset", CLOUDINARY_UPLOAD_PRESET);

      const res = await fetch(CLOUDINARY_UPLOAD_URL, { method:"POST", body: fd });
      if(!res.ok) throw new Error("Cloudinary upload failed");
      const json = await res.json();
      if(!json.secure_url) throw new Error("Cloudinary: missing secure_url");
      return json.secure_url;
    }

    // ‚úÖ MULTI
    async function uploadManyToCloudinary(fileList){
      const arr = Array.from(fileList || []);
      const limited = arr.slice(0, MAX_UPLOAD_IMAGES);
      if(!limited.length) return [];
      return await Promise.all(limited.map(uploadToCloudinary));
    }

    async function callWebhook(url, payload){
      const res = await fetch(url, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify(payload)
      });

      if(!res.ok){
        const txt = await res.text().catch(()=> "");
        throw new Error("n8n error: " + (txt || res.status));
      }
      return await res.json();
    }

    function buildCommonPayload(){
      return {
        product_name: (productNameEl.value || "").trim(),
        product_price: (productPriceEl.value || "").toString().trim(),
        user_email: (emailEl.value || "").trim(),
        user_phone: (phoneEl.value || "").trim(),
        resolution: FIXED_RESOLUTION,
        aspectRatio: aspectEl.value
      };
    }

    // ‚úÖ MULTI UI
    function updateFileUI(files){
      const arr = Array.from(files || []);
      if(!arr.length){
        fileTitle.textContent = "Drop images here (or browse)";
        fileSub.textContent = "PNG / JPG ‚Ä¢ up to 8 ‚Ä¢ optional";
        return;
      }
      const names = arr.slice(0,2).map(f => f.name).join(", ");
      const more = arr.length > 2 ? ` +${arr.length - 2} more` : "";
      fileTitle.textContent = `${arr.length} image(s) selected`;
      fileSub.textContent = `${names}${more}`;
    }

    // ‚úÖ Generate (multi)
    submitBtn.addEventListener("click", async () => {
      stopPolling();
      setStatus("");
      setTask(null);
      setEditStatus("");

      const prompt = (promptEl.value || "").trim();
      if(!prompt){
        setStatus("Write a prompt first.");
        return;
      }

      submitBtn.disabled = true;
      recheckBtn.disabled = true;

      setOverlay(true, "Generating‚Ä¶");
      setStatus("Processing‚Ä¶");
      clearResult();

      try{
        const files = fileInput.files;
        let image_urls = [];

        if(files && files.length){
          setOverlay(true, "Uploading images‚Ä¶");
          image_urls = await uploadManyToCloudinary(files);
        }

        setModeFromCount(image_urls.length);

        const payload = {
          ...buildCommonPayload(),
          mode: image_urls.length ? "img2img" : "txt2img",
          prompt_user: prompt
        };

        // ‚úÖ MULTI: envoie plusieurs formats (choisis celui que ton n8n utilise)
        if(image_urls.length){
          payload.image_url = image_urls[0];     // compat ‚Äú1 image‚Äù
          payload.image_urls = image_urls;       // fal style
          payload.imageUrls = image_urls;        // nanobananaapi style
        }

        const data = await callWebhook(N8N_GENERATE_URL, payload);
        const r = normalizeResponse(data);

        if(r.status === "done" && r.image){
          setOverlay(false);
          setStatus("Done ‚úÖ");
          setResult(r.image, { generated: true });
          
          // Sauvegarde dans l'historique
          saveGeneration({
            imageUrl: r.image,
            prompt: prompt,
            aspectRatio: aspectRatio,
            mode: image_urls.length ? 'image-to-image' : 'text-to-image'
          });
        } else if(r.status === "failed"){
          setOverlay(false);
          setStatus("Failed ‚ùå " + (r.errorMessage || ""));
        } else {
          setStatus("Processing‚Ä¶ (not ready on first check)");
          setOverlay(true, "Still processing‚Ä¶");
        }

      } catch(e){
        setOverlay(false);
        setStatus("Error: " + (e.message || e));
      } finally {
        submitBtn.disabled = false;
      }
    });

    // ‚úÖ Apply modifications (option: inclure des images de r√©f√©rence upload√©es)
    applyEditBtn.addEventListener("click", async () => {
      setEditStatus("");
      const editPrompt = (editPromptEl.value || "").trim();
      if(!lastGeneratedUrl){
        setEditStatus("G√©n√®re une image d‚Äôabord.");
        return;
      }
      if(!editPrompt){
        setEditStatus("√âcris une instruction de modification.");
        return;
      }

      applyEditBtn.disabled = true;
      clearEditBtn.disabled = true;

      setOverlay(true, "Applying changes‚Ä¶");
      setStatus("Editing‚Ä¶");

      try{
        const endpoint = (N8N_EDIT_URL || N8N_GENERATE_URL);

        // ‚úÖ MULTI (refs optionnels)
        let ref_urls = [];
        if(fileInput.files && fileInput.files.length){
          setOverlay(true, "Uploading reference images‚Ä¶");
          ref_urls = await uploadManyToCloudinary(fileInput.files);
        }

        const payload = {
          ...buildCommonPayload(),
          mode: "edit",
          base_image_url: lastGeneratedUrl,
          edit_prompt: editPrompt,
          prompt_user: (promptEl.value || "").trim()
        };

        // optionnel: refs
        if(ref_urls.length){
          payload.reference_image_urls = ref_urls;
          payload.image_urls = [lastGeneratedUrl, ...ref_urls];
          payload.imageUrls = [lastGeneratedUrl, ...ref_urls];
        }

        const data = await callWebhook(endpoint, payload);
        const r = normalizeResponse(data);

        if(r.status === "done" && r.image){
          setOverlay(false);
          setStatus("Updated ‚úÖ");
          setEditStatus("Modification appliqu√©e ‚úÖ");
          setResult(r.image, { generated: true });
        } else if(r.status === "failed"){
          setOverlay(false);
          setEditStatus("Failed ‚ùå " + (r.errorMessage || ""));
          setStatus("Failed ‚ùå");
        } else {
          setEditStatus("Processing‚Ä¶ (pas pr√™t au premier check)");
          setOverlay(true, "Still processing‚Ä¶");
        }
      } catch(e){
        setOverlay(false);
        setEditStatus("Error: " + (e.message || e));
        setStatus("Error: " + (e.message || e));
      } finally {
        applyEditBtn.disabled = false;
        clearEditBtn.disabled = false;
      }
    });

    clearEditBtn.addEventListener("click", () => {
      editPromptEl.value = "";
      setEditStatus("");
    });

    browseBtn.addEventListener("click", () => fileInput.click());
    clearBtn.addEventListener("click", () => {
      fileInput.value = "";
      updateFileUI(null);
      setModeFromCount(0);
      setStatus("Images cleared.");
    });

    // ‚úÖ MULTI change
    fileInput.addEventListener("change", () => {
      const files = fileInput.files || null;
      const count = files ? files.length : 0;
      updateFileUI(files);
      setModeFromCount(count);

      if(count){
        const url = URL.createObjectURL(files[0]); // preview 1√®re image
        clearResult();
        setResult(url, { generated: false });
        setStatus(`${count} image(s) ready (optional).`);
      } else {
        setModeFromCount(0);
      }
    });

    // drag/drop multi
    ;["dragenter","dragover"].forEach(evt => {
      dropZone.addEventListener(evt, (e) => {
        e.preventDefault();
        dropZone.style.borderColor = "rgba(99,102,241,.55)";
        dropZone.style.background = "rgba(0,0,0,.30)";
      });
    });
    ;["dragleave","drop"].forEach(evt => {
      dropZone.addEventListener(evt, (e) => {
        e.preventDefault();
        dropZone.style.borderColor = "rgba(255,255,255,.20)";
        dropZone.style.background = "rgba(0,0,0,.22)";
      });
    });
    dropZone.addEventListener("drop", (e) => {
      const files = e.dataTransfer.files;
      if(!files || !files.length) return;

      fileInput.files = files; // (fonctionne dans la plupart des navigateurs)
      updateFileUI(files);
      setModeFromCount(files.length);

      const url = URL.createObjectURL(files[0]);
      clearResult();
      setResult(url, { generated: false });
      setStatus(`${files.length} image(s) ready (optional).`);
    });

    resetBtn.addEventListener("click", () => {
      stopPolling();
      productNameEl.value = "";
      productPriceEl.value = "";
      emailEl.value = "";
      phoneEl.value = "";
      promptEl.value = "";
      fileInput.value = "";
      updateFileUI(null);
      setModeFromCount(0);
      setTask(null);
      clearResult();
      setOverlay(false);
      setStatus("Ready.");
    });

    setStatus("Ready.");
    updateFileUI(null);
    setModeFromCount(0);
  </script>
</body>
</html>

