<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
  <link rel="shortcut icon" href="favicon.ico">
  <link rel="manifest" href="site.webmanifest">
  <title>NEORAPRODUITS</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  
  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <script src="neora-tracker.js"></script>
  
  <style>
    :root{
      --bg0:#050714;
      --bg1:#070a1a;

      /* ‚úÖ glass + lisible */
      --card:rgba(255,255,255,.035);
      --card2:rgba(255,255,255,.055);
      --border:rgba(255,255,255,.12);

      --text:rgba(255,255,255,.94);
      --muted:rgba(255,255,255,.72);
      --muted2:rgba(255,255,255,.56);

      --shadow: 0 24px 80px rgba(0,0,0,.60);
      --shadow2: 0 12px 34px rgba(0,0,0,.35);

      --radius:18px;
      --radius2:14px;

      --focus: 0 0 0 4px rgba(99,102,241,.22);
      --grad: linear-gradient(135deg,#6366f1,#ec4899 45%,#22d3ee);

      /* ‚úÖ input glass */
      --field-bg: rgba(0,0,0,.32);
      --field-bg-focus: rgba(0,0,0,.40);
      --field-border: rgba(255,255,255,.18);
      --field-border-hover: rgba(255,255,255,.26);
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      color:var(--text);
      background:
        radial-gradient(1200px 600px at 20% 0%, rgba(99,102,241,.20), transparent 60%),
        radial-gradient(900px 500px at 80% 10%, rgba(236,72,153,.18), transparent 55%),
        radial-gradient(900px 700px at 50% 110%, rgba(34,211,238,.12), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow-x:hidden;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:24px;
    }

    /* Card */
    .card{
      width:100%;
      max-width: 980px;

      /* ‚úÖ plus transparent mais lisible */
      background: linear-gradient(180deg, rgba(255,255,255,.045), rgba(255,255,255,.02));
      border: 1px solid var(--border);
      border-radius: 22px;
      padding: 22px;
      box-shadow: var(--shadow);
      position:relative;
      overflow:hidden;

      backdrop-filter: blur(18px) saturate(130%);
      -webkit-backdrop-filter: blur(18px) saturate(130%);
    }
    .card:before{
      content:"";
      position:absolute;
      inset:-2px;
      background:
        radial-gradient(600px 260px at 20% 0%, rgba(99,102,241,.22), transparent 60%),
        radial-gradient(520px 260px at 85% 8%, rgba(236,72,153,.18), transparent 60%);
      pointer-events:none;
      filter: blur(2px);
      opacity:.9;
    }
    .card-inner{ position:relative; z-index:1; }

    /* Header */
    .header{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:14px;
      margin-bottom: 14px;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:12px;
    }
    .logo{
      width:38px; height:38px;
      border-radius: 12px;
      background: url('logo.jpg') center/cover no-repeat;
      box-shadow: 0 12px 35px rgba(99,102,241,.22);
      position:relative;
      flex:0 0 auto;
    }
    .logo:after{
      content:"";
      position:absolute; inset:1px;
      border-radius:11px;
      background: linear-gradient(180deg, rgba(0,0,0,.18), rgba(255,255,255,.06));
      mix-blend-mode: overlay;
    }
    h1{
      font-size: 1.05rem;
      margin:0;
      letter-spacing:.42em;
      text-transform:uppercase;
      line-height:1.1;
      color: rgba(255,255,255,.96);
    }
    p.subtitle{
      margin:6px 0 0;
      font-size:.92rem;
      color: var(--muted);
      line-height:1.35;
    }
    .badge{
      font-size: 12px;
      color: rgba(255,255,255,.82);
      padding: 7px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      white-space:nowrap;
      height: fit-content;
    }
    
    /* Navigation */
    .nav-links {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .nav-link {
      padding: 8px 14px;
      border-radius: 999px;
      font-size: 13px;
      font-weight: 500;
      text-decoration: none;
      color: rgba(255,255,255,.7);
      transition: all 0.2s;
    }
    .nav-link:hover {
      color: rgba(255,255,255,.95);
      background: rgba(255,255,255,.08);
    }
    .header-right {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    @media (max-width: 600px) {
      .nav-links { display: none; }
    }

    /* Layout */
    .content-row{
      display:flex;
      gap: 22px;
      align-items:flex-start;
    }
    .form-column{ flex:1; min-width:0; }
    .preview-column{
      flex:1; min-width:0;
      border-left: 1px solid rgba(255,255,255,.12);
      padding-left: 20px;
    }
    @media (max-width: 800px){
      body{ padding: 16px; }
      .content-row{ flex-direction:column; }
      .preview-column{
        border-left:none;
        border-top: 1px solid rgba(255,255,255,.12);
        padding-left:0;
        padding-top: 16px;
      }
    }

    /* Fields */
    label{
      display:block;
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 6px;
      letter-spacing:.02em;
    }
    .field{ margin-bottom: 14px; }

    input[type="text"], select, textarea{
      width:100%;
      padding: 12px 12px;
      border-radius: 14px;
      border: 1px solid var(--field-border);
      background: var(--field-bg);
      color: var(--text);
      font-size: .95rem;
      outline:none;
      transition: border .15s ease, box-shadow .15s ease, background .15s ease;
      box-shadow: 0 10px 26px rgba(0,0,0,.22);
    }
    input[type="text"]:hover, select:hover, textarea:hover{
      border-color: var(--field-border-hover);
    }
    textarea{ min-height: 120px; resize: vertical; }
    input[type="text"]:focus, select:focus, textarea:focus{
      border-color: rgba(99,102,241,.62);
      background: var(--field-bg-focus);
      box-shadow: var(--focus), 0 12px 34px rgba(0,0,0,.30);
    }

    /* ‚úÖ Select compact + arrow propre (style d'image) */
    #image_style{
      height: 42px;
      padding: 8px 40px 8px 12px;
      font-size: 13px;
      font-weight: 900;
      border-radius: 12px;

      appearance:none;
      -webkit-appearance:none;
      -moz-appearance:none;

      background-image:
        linear-gradient(45deg, transparent 50%, rgba(255,255,255,.95) 50%),
        linear-gradient(135deg, rgba(255,255,255,.95) 50%, transparent 50%);
      background-position:
        calc(100% - 16px) 50%,
        calc(100% - 11px) 50%;
      background-size: 5px 5px, 5px 5px;
      background-repeat:no-repeat;
    }
    /* ‚úÖ options dropdown lisibles (Chrome/Edge) */
    #image_style option{
      background:#0b1026 !important;
      color:rgba(255,255,255,.95) !important;
      font-weight:800 !important;
    }

    /* File */
    input[type="file"]{
      width:100%;
      font-size: .9rem;
      color: rgba(255,255,255,.86);
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px dashed rgba(255,255,255,.22);
      background: rgba(0,0,0,.22);
      cursor:pointer;
      box-shadow: 0 10px 26px rgba(0,0,0,.18);
    }
    input[type="file"]::-webkit-file-upload-button{
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.07);
      color: rgba(255,255,255,.94);
      padding: 9px 12px;
      border-radius: 999px;
      cursor:pointer;
      font-weight:900;
      margin-right: 10px;
    }

    /* Buttons */
    button{
      width:100%;
      padding: 12px 14px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-weight: 900;
      font-size: .95rem;
      background: var(--grad);
      color: white;
      margin-top: 6px;
      box-shadow: 0 18px 45px rgba(99,102,241,.18);
      transition: transform .12s ease, opacity .12s ease, filter .12s ease;
    }
    button:hover{ transform: translateY(-1px); filter: brightness(1.03); }
    button:active{ transform: translateY(0px); }
    button:disabled{ opacity:.55; cursor:default; transform:none; }

    .btn-secondary{
      background: rgba(255,255,255,.07);
      border: 1px solid rgba(255,255,255,.14);
      box-shadow: 0 10px 30px rgba(0,0,0,.20);
    }

    .status{
      margin-top: 12px;
      font-size: 0.9rem;
      color: var(--muted);
      min-height: 1.2em;
      white-space: pre-wrap;
    }

    /* Loader */
    .loader{
      margin-top: 12px;
      display:none;
      flex-direction: row;
      align-items:center;
      gap: 10px;
      font-size: .9rem;
      color: rgba(255,255,255,.92);
      padding: 10px 12px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      width: fit-content;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    .spinner{
      width: 18px; height: 18px;
      border-radius:999px;
      border: 3px solid rgba(255,255,255,.22);
      border-top-color: rgba(255,255,255,.95);
      animation: spin .8s linear infinite;
    }
    @keyframes spin{ to{ transform: rotate(360deg);} }

    /* Preview */
    .preview{ display:none; }
    .preview h2{
      font-size: 1rem;
      margin: 0 0 10px;
      letter-spacing:.02em;
      color: rgba(255,255,255,.92);
    }
    .preview-frame{
      position:relative;
      width:100%;
      border-radius: 16px;
      overflow:hidden;

      /* ‚úÖ plus lisible (cadre + contraste) */
      background: rgba(0,0,0,.26);
      border: 1px solid rgba(255,255,255,.12);
      min-height: 260px;
      box-shadow: 0 18px 60px rgba(0,0,0,.35);
      display:grid;
      place-items:center;
    }
    .preview-frame img{
      width:100%;
      max-height: 520px;
      object-fit: contain;
      display:block;
    }
    .preview-overlay{
      position:absolute;
      inset:0;
      background: rgba(5,7,20,.62);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      display:none;
      align-items:center;
      justify-content:center;
      flex-direction:column;
      gap: 10px;
      font-size: .95rem;
      color: rgba(255,255,255,.94);
    }
    .preview-overlay .spinner{ width: 28px; height: 28px; border-width: 4px; }

    .actions-row{
      display:flex;
      gap:10px;
      margin-top: 12px;
    }

    .tiny{
      font-size: 12px;
      color: var(--muted2);
      margin-top: 6px;
      line-height:1.4;
    }
    .divider{
      height:1px;
      background: rgba(255,255,255,.12);
      margin: 16px 0 12px;
    }
  </style>
</head>

<body>
  <div class="card">
    <div class="card-inner">
      <div class="header">
        <a href="index.html" class="brand" style="text-decoration:none;">
          <div class="logo"></div>
          <div>
            <div class="logo-text" style="font-size:22px;font-weight:700;">Neora<span style="background:var(--grad);-webkit-background-clip:text;-webkit-text-fill-color:transparent;">.ai</span></div>
            <p class="subtitle">G√©n√©rateur d‚Äôimages produit.</p>
          </div>
        </div>
        <div class="header-right">
          <div class="nav-links">
            
            <a href="index.html" class="nav-link">üè† Accueil</a>
            <a href="selector.html" class="nav-link">üöÄ App</a>
            <a href="pricing.html" class="nav-link">üíé Tarifs</a>
            <a href="historique.html" class="nav-link">üìÅ Historique</a>
            <a href="profil.html" class="nav-link">üë§ Profil</a>
            <a href="contact.html" class="nav-link">üì¨ Contact</a>
          </div>
          
          <div class="badge" id="generation-counter" style="background: rgba(16,185,129,0.15); border-color: rgba(16,185,129,0.3); color: #10b981;">-- g√©n√©rations restantes</div>
        </div>
      </div>

      <div class="content-row">
        <!-- Colonne gauche -->
        <div class="form-column">
          <form id="generate-form">
            <div class="field">
              <label for="product_name">Nom du produit</label>
              <input type="text" id="product_name" name="product_name" required placeholder="Ex: Nike Air Max 270" />
            </div>

            <div class="field">
              <label for="image_style">Style d'image</label>
              <select id="image_style" name="image_style" required>
                <option value="fond_blanc">Fond blanc</option>
                <option value="fond_colore_moderne">Fond color√© moderne</option>
                <option value="studio_3d_premium">Studio 3D premium</option>
                <option value="effet_splash_creatif">Effet splash cr√©atif</option>
                <option value="scene_lifestyle">Sc√®ne lifestyle</option>
                <option value="style_personnalise">Style personnalis√©</option>
              </select>
            </div>

            <div class="field" id="custom-style-field" style="display:none;">
              <label for="custom_style">Style personnalis√©</label>
              <textarea id="custom_style" placeholder="Ex: fond noir, n√©ons violets, ambiance futuriste, lumi√®re dramatique..."></textarea>
              <div class="tiny">Sois pr√©cis : ambiance, couleurs, type de lumi√®re, mood.</div>
            </div>

            <div class="field">
              <label for="product_image">Image du produit</label>
              <input type="file" id="product_image" name="product_image" accept="image/*" required />
              <div class="tiny">Tu upload la photo brute, Neora renvoie la version marketing.</div>
            </div>

            <button type="submit" id="submit-btn">G√©n√©rer</button>
            <div class="status" id="status"></div>

            <div class="loader" id="loader">
              <div class="spinner"></div>
              <div id="loader-text">Traitement en cours‚Ä¶</div>
            </div>
          </form>

          <!-- ‚úÖ MODIFICATIONS -->
          <div id="edit-section" style="margin-top:18px; display:none;">
            <div class="divider"></div>
            <div class="field">
              <label for="edit_text">Modifier l'image g√©n√©r√©e</label>
              <textarea id="edit_text" placeholder="Ex: rends le fond plus sombre, ajoute un l√©ger glow, am√©liore la nettet√©..."></textarea>
              <div class="tiny">Cette action r√©utilise la derni√®re image g√©n√©r√©e comme base.</div>
            </div>
            <button type="button" id="edit-btn" class="btn-secondary" disabled>Appliquer les modifications</button>
          </div>
        </div>

        <!-- Colonne droite -->
        <div class="preview-column">
          <div class="preview" id="preview">
            <h2>R√©sultat</h2>
            <div class="preview-frame">
              <img id="preview-image" alt="Aper√ßu image produit" />
              <div class="preview-overlay" id="preview-overlay">
                <div class="spinner"></div>
                <div id="overlay-text">G√©n√©ration‚Ä¶</div>
              </div>
            </div>

            <div class="actions-row">
              <button type="button" id="download-btn" class="btn-secondary" disabled>T√©l√©charger</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Firebase config - doit √™tre initialis√© avant tout
    const firebaseConfig = {
      apiKey: "AIzaSyCKPepYjXiY92hZPEdKxqOow9AACfMTOoc",
      authDomain: "neorastudiosnc.firebaseapp.com",
      projectId: "neorastudiosnc",
      storageBucket: "neorastudiosnc.firebasestorage.app",
      messagingSenderId: "275455765566",
      appId: "1:275455765566:web:c2cf516fcb8f13de7e356f"
    };
    
    // Initialiser Firebase si pas d√©j√† fait
    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
    
    const db = firebase.firestore();
    
    // Fonction pour cr√©er ou mettre √† jour le document utilisateur
    async function ensureUserDocument(user) {
      if (!user) return;
      
      const userRef = db.collection('users').doc(user.uid);
      const userDoc = await userRef.get();
      const currentMonth = getCurrentMonth();
      
      if (!userDoc.exists) {
        // Nouveau utilisateur ‚Üí cr√©er avec tous les champs
        await userRef.set({
          email: user.email,
          firstName: '',
          lastName: '',
          avatarUrl: user.photoURL || '',
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          lastLoginAt: firebase.firestore.FieldValue.serverTimestamp(),
          blocked: false,
          provider: user.providerData[0]?.providerId || 'email',
          plan: 'free',
          generationsAvailable: 0,
          lastBonusMonth: '',
          totalGenerations: 0,
          monthlyGenerations: 0,
          lastGenerationMonth: ''
        });
      } else {
        // Utilisateur existant ‚Üí mettre √† jour lastLoginAt
        await userRef.update({
          lastLoginAt: firebase.firestore.FieldValue.serverTimestamp()
        });
      }
    }
    
    // Fonction pour v√©rifier si l'utilisateur est bloqu√©
    async function checkIfBlocked(user) {
      if (!user) return false;
      
      const userDoc = await db.collection('users').doc(user.uid).get();
      if (userDoc.exists && userDoc.data().blocked === true) {
        alert('Votre compte a √©t√© suspendu. Contactez le support pour plus d\'informations.');
        firebase.auth().signOut();
        window.location.href = 'index.html';
        return true;
      }
      return false;
    }
    
    // Fonction pour v√©rifier si l'utilisateur a un plan payant
    async function checkPlanAccess(user) {
      if (!user) return false;
      
      const userDoc = await db.collection('users').doc(user.uid).get();
      if (userDoc.exists) {
        const plan = userDoc.data().plan || 'free';
        if (plan === 'free') {
          alert('Cette version n√©cessite un abonnement Pro. Vous allez √™tre redirig√© vers la page des tarifs.');
          window.location.href = 'pricing.html';
          return false;
        }
        return true;
      }
      return false;
    }
    
    // ========== SYST√àME DE G√âN√âRATIONS ==========
    const MONTHLY_BONUS = 50;
    let generationsAvailable = 0;
    
    function getCurrentMonth() {
      const now = new Date();
      return `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
    }
    
    async function loadGenerations(user) {
      if (!user) return 0;
      
      const userRef = db.collection('users').doc(user.uid);
      const userDoc = await userRef.get();
      
      if (userDoc.exists) {
        const data = userDoc.data();
        const currentMonth = getCurrentMonth();
        
        if (data.lastBonusMonth !== currentMonth) {
          const currentGenerations = data.generationsAvailable || 0;
          generationsAvailable = currentGenerations + MONTHLY_BONUS;
          
          await userRef.update({
            generationsAvailable: generationsAvailable,
            lastBonusMonth: currentMonth
          });
        } else {
          generationsAvailable = data.generationsAvailable || 0;
        }
        
        updateGenerationCounter();
        return generationsAvailable;
      }
      return 0;
    }
    
    function canGenerate() {
      return generationsAvailable > 0;
    }
    
    async function decrementGeneration(user) {
      if (!user || generationsAvailable <= 0) return;
      
      generationsAvailable--;
      
      await db.collection('users').doc(user.uid).update({
        generationsAvailable: generationsAvailable
      });
      
      updateGenerationCounter();
    }
    
    function updateGenerationCounter() {
      const counterEl = document.getElementById('generation-counter');
      if (counterEl) {
        counterEl.textContent = `‚ö° ${generationsAvailable} g√©n√©ration${generationsAvailable > 1 ? 's' : ''}`;
        
        if (generationsAvailable > 20) {
          counterEl.style.color = '#10b981';
        } else if (generationsAvailable > 5) {
          counterEl.style.color = '#f59e0b';
        } else {
          counterEl.style.color = '#ef4444';
        }
      }
    }
    // ========== FIN SYST√àME DE G√âN√âRATIONS ==========
    
    // Protection: V√©rifier si l'utilisateur est connect√© et non bloqu√©
    firebase.auth().onAuthStateChanged(async (user) => {
      if (!user) {
        window.location.href = 'index.html';
        return;
      }
      
      // Cr√©er/mettre √† jour le document utilisateur
      await ensureUserDocument(user);
      
      // V√©rifier si bloqu√©
      const isBlocked = await checkIfBlocked(user);
      if (isBlocked) return;
      
      // V√©rifier si l'utilisateur a acc√®s (plan payant)
      const hasAccess = await checkPlanAccess(user);
      if (!hasAccess) return;
      
      // Charger les g√©n√©rations disponibles
      await loadGenerations(user);
    });
    
    // Initialisation du tracker NEORA
    initNeoraTracker('NEORAPRODUITS');
    
    // ‚úÖ TES VALEURS
    const CLOUDINARY_UPLOAD_URL = "https://api.cloudinary.com/v1_1/diegfxcyl/image/upload";
    const CLOUDINARY_UPLOAD_PRESET = "neora_upload";
    const N8N_WEBHOOK_URL = "https://n8n.srv1125399.hstgr.cloud/webhook/64874f6e-5112-4928-a3a1-adbd844c7491";

    const form = document.getElementById("generate-form");
    const statusEl = document.getElementById("status");
    const submitBtn = document.getElementById("submit-btn");
    const loaderEl = document.getElementById("loader");
    const loaderTextEl = document.getElementById("loader-text");

    const fileInput = document.getElementById("product_image");
    const downloadBtn = document.getElementById("download-btn");

    const editSection = document.getElementById("edit-section");
    const editTextarea = document.getElementById("edit_text");
    const editBtn = document.getElementById("edit-btn");

    const previewEl = document.getElementById("preview");
    const previewImgEl = document.getElementById("preview-image");
    const previewOverlayEl = document.getElementById("preview-overlay");
    const overlayTextEl = document.getElementById("overlay-text");

    const imageStyleSelect = document.getElementById("image_style");
    const customStyleField = document.getElementById("custom-style-field");
    const customStyleTextarea = document.getElementById("custom_style");

    // derni√®re image connue (pour it√©rations)
    let currentImageUrl = null;

    function setLoading(isLoading, text){
      loaderTextEl.textContent = text || "Traitement en cours‚Ä¶";
      loaderEl.style.display = isLoading ? "flex" : "none";
    }
    function setOverlay(show, text){
      overlayTextEl.textContent = text || "G√©n√©ration‚Ä¶";
      previewOverlayEl.style.display = show ? "flex" : "none";
    }

    imageStyleSelect.addEventListener("change", () => {
      if (imageStyleSelect.value === "style_personnalise") {
        customStyleField.style.display = "block";
      } else {
        customStyleField.style.display = "none";
        if (customStyleTextarea) customStyleTextarea.value = "";
      }
    });

    // preview instant de l'image brute
    fileInput.addEventListener("change", () => {
      const file = fileInput.files[0];
      if (!file) return;
      const objectUrl = URL.createObjectURL(file);
      previewImgEl.src = objectUrl;
      previewEl.style.display = "block";
      setOverlay(false);
      statusEl.textContent = "";
    });

    async function uploadToCloudinary(file){
      const imgFormData = new FormData();
      imgFormData.append("file", file);
      imgFormData.append("upload_preset", CLOUDINARY_UPLOAD_PRESET);

      const uploadRes = await fetch(CLOUDINARY_UPLOAD_URL, { method: "POST", body: imgFormData });
      if (!uploadRes.ok) throw new Error("Erreur lors de l'upload Cloudinary.");
      const uploadData = await uploadRes.json();
      const url = uploadData.secure_url;
      if (!url) throw new Error("Cloudinary n'a pas renvoy√© secure_url.");
      return url;
    }

    async function callNeora(payload){
      const n8nRes = await fetch(N8N_WEBHOOK_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      if (!n8nRes.ok) throw new Error("Erreur lors de l'appel √† Neora.");
      return await n8nRes.json();
    }

    function extractImageUrl(n8nData){
      return (
        n8nData?.image_url ||
        n8nData?.myField ||
        n8nData?.resultImageUrl ||
        n8nData?.data?.response?.resultImageUrl ||
        n8nData?.data?.info?.resultImageUrl ||
        null
      );
    }

    function lockUI(lock, loaderText){
      submitBtn.disabled = lock;
      editBtn.disabled = lock || !currentImageUrl;
      downloadBtn.disabled = lock || !currentImageUrl;
      setLoading(lock, loaderText || "Traitement en cours‚Ä¶");
      setOverlay(lock, loaderText ? loaderText.replace("‚Ä¶","") : "G√©n√©ration‚Ä¶");
    }

    function enablePostGenerationFeatures(){
      editSection.style.display = "block";
      editBtn.disabled = false;
      downloadBtn.disabled = false;
    }

    // 1) G√©n√©ration initiale
    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      // V√©rifier la limite de g√©n√©rations
      if (!canGenerate()) {
        statusEl.textContent = "‚ùå Plus de g√©n√©rations disponibles !";
        alert('Vous n\'avez plus de g√©n√©rations disponibles. Achetez un pack de cr√©dits pour continuer.');
        return;
      }

      const productName = document.getElementById("product_name").value.trim();
      const imageStyle = imageStyleSelect.value;
      const customStyleText = customStyleTextarea ? customStyleTextarea.value.trim() : "";
      const file = fileInput.files[0];

      if (!productName) { statusEl.textContent = "Merci d'indiquer le nom du produit."; return; }
      if (!file) { statusEl.textContent = "Merci de choisir une image produit."; return; }

      statusEl.textContent = "";
      previewEl.style.display = "block";
      lockUI(true, "Upload‚Ä¶");

      try {
        const imageUrl = await uploadToCloudinary(file);
        currentImageUrl = imageUrl;

        lockUI(true, "G√©n√©ration‚Ä¶");

        const payload = {
          product_name: productName,
          image_style: imageStyle,
          image_url: currentImageUrl
        };
        if (imageStyle === "style_personnalise" && customStyleText) payload.custom_style = customStyleText;

        const n8nData = await callNeora(payload);
        const finalImageUrl = extractImageUrl(n8nData);
        if (!finalImageUrl) throw new Error("Impossible de trouver l'URL de l'image dans la r√©ponse.");

        statusEl.textContent = "Chargement de l'image g√©n√©r√©e‚Ä¶";

        previewImgEl.onload = async () => {
          lockUI(false);
          setOverlay(false);
          setLoading(false);
          statusEl.textContent = "Image g√©n√©r√©e ‚úÖ";
          enablePostGenerationFeatures();
          
          // D√©cr√©menter le compteur de g√©n√©rations
          const user = firebase.auth().currentUser;
          if (user) {
            await decrementGeneration(user);
          }
          
          // Sauvegarde dans l'historique
          saveGeneration({
            imageUrl: finalImageUrl,
            prompt: productName + ' - ' + imageStyle,
            aspectRatio: '1:1',
            mode: 'image-to-image'
          });
        };
        previewImgEl.onerror = () => {
          lockUI(false);
          setOverlay(false);
          setLoading(false);
          statusEl.textContent = "Erreur lors du chargement de l'image.";
        };

        currentImageUrl = finalImageUrl;
        previewImgEl.src = finalImageUrl;

        downloadBtn.onclick = () => {
          const a = document.createElement("a");
          a.href = currentImageUrl;
          a.download = (productName || "neora-image") + ".png";
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
        };

      } catch (err) {
        console.error(err);
        lockUI(false);
        setOverlay(false);
        setLoading(false);
        statusEl.textContent = "Une erreur est survenue : " + err.message;
      } finally {
        submitBtn.disabled = false;
      }
    });

    // 2) Modifications (it√©ration sur l'image g√©n√©r√©e)
    editBtn.addEventListener("click", async () => {
      const editText = (editTextarea.value || "").trim();
      const productName = document.getElementById("product_name").value.trim();

      if (!currentImageUrl) { statusEl.textContent = "Aucune image √† modifier."; return; }
      if (!editText) { statusEl.textContent = "√âcris d'abord la modification √† appliquer."; return; }

      statusEl.textContent = "";
      previewEl.style.display = "block";
      lockUI(true, "Modification‚Ä¶");

      try {
        const payload = {
          product_name: productName || "Neora",
          image_style: "style_personnalise",
          image_url: currentImageUrl,
          edit_instructions: editText
        };

        const n8nData = await callNeora(payload);
        const finalImageUrl = extractImageUrl(n8nData);
        if (!finalImageUrl) throw new Error("Impossible de trouver l'URL de l'image dans la r√©ponse.");

        statusEl.textContent = "Chargement de l'image modifi√©e‚Ä¶";

        previewImgEl.onload = () => {
          lockUI(false);
          setOverlay(false);
          setLoading(false);
          statusEl.textContent = "Modifications appliqu√©es ‚úÖ";
          editTextarea.value = "";
        };
        previewImgEl.onerror = () => {
          lockUI(false);
          setOverlay(false);
          setLoading(false);
          statusEl.textContent = "Erreur lors du chargement de l'image.";
        };

        currentImageUrl = finalImageUrl;
        previewImgEl.src = finalImageUrl;

        downloadBtn.onclick = () => {
          const a = document.createElement("a");
          a.href = currentImageUrl;
          a.download = (productName || "neora-image") + ".png";
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
        };

      } catch (err) {
        console.error(err);
        lockUI(false);
        setOverlay(false);
        setLoading(false);
        statusEl.textContent = "Une erreur est survenue : " + err.message;
      } finally {
        editBtn.disabled = false;
      }
    });
  </script>
</body>
</html>
