<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
  <link rel="shortcut icon" href="favicon.ico">
  <link rel="manifest" href="site.webmanifest">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NEORA</title>
  
  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <script src="neora-tracker.js"></script>
  
  <style>
    :root{
      --bg0:#050714;
      --bg1:#070a1a;

      /* panels glass */
      --card: rgba(255,255,255,.045);
      --border: rgba(255,255,255,.14);

      /* text */
      --text: rgba(255,255,255,.95);
      --muted: rgba(255,255,255,.75);
      --muted2: rgba(255,255,255,.60);

      --shadow2: 0 20px 70px rgba(0,0,0,.65);
      --radius:20px;
      --focus: 0 0 0 4px rgba(99,102,241,.28);
      --grad: linear-gradient(135deg,#6366f1,#a855f7 35%,#ec4899 65%,#22d3ee);

      /* input glass */
      --field-bg: rgba(0,0,0,.38);
      --field-border: rgba(255,255,255,.18);
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      color:var(--text);
      background:
        radial-gradient(1200px 600px at 20% 0%, rgba(99,102,241,.22), transparent 60%),
        radial-gradient(900px 500px at 80% 10%, rgba(236,72,153,.18), transparent 55%),
        radial-gradient(900px 700px at 50% 110%, rgba(34,211,238,.12), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow-x:hidden;
    }

    /* Topbar */
    .topbar{
      position:sticky; top:0; z-index:10;
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      background: linear-gradient(180deg, rgba(5,7,20,.76), rgba(5,7,20,.48));
      border-bottom: 1px solid rgba(255,255,255,.08);
    }
    .topbar-inner{
      max-width:1100px;
      margin:0 auto;
      padding:16px 20px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:14px;
    }
    .brand{ display:flex; align-items:center; gap:12px; user-select:none; }
    .logo{
      width:34px; height:34px; border-radius:10px;
      background: url('logo.jpg') center/cover no-repeat;
      box-shadow: 0 14px 40px rgba(99,102,241,.22);
      position:relative;
    }
    .logo:after{
      content:"";
      position:absolute; inset:1px;
      border-radius:9px;
      background: linear-gradient(180deg, rgba(0,0,0,.18), rgba(255,255,255,.08));
      mix-blend-mode: overlay;
    }
    .brand h1{
      margin:0;
      font-size:15px;
      letter-spacing:.35em;
      text-transform:uppercase;
      line-height:1;
      color: rgba(255,255,255,.95);
    }
    .badge{
      font-size:12px;
      color: rgba(255,255,255,.78);
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.045);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      box-shadow: 0 10px 30px rgba(0,0,0,.22);
      white-space:nowrap;
    }
    
    /* Navigation */
    .nav-links {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .nav-link {
      padding: 8px 14px;
      border-radius: 999px;
      font-size: 13px;
      font-weight: 500;
      text-decoration: none;
      color: rgba(255,255,255,.7);
      transition: all 0.2s;
    }
    .nav-link:hover {
      color: rgba(255,255,255,.95);
      background: rgba(255,255,255,.08);
    }
    .topbar-right {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    @media (max-width: 600px) {
      .nav-links { display: none; }
    }

    /* Layout */
    .wrap{
      max-width:1100px;
      margin: 0 auto;
      padding: 22px 20px 34px;
    }
    .grid{
      display:grid;
      grid-template-columns: 420px 1fr;
      gap:16px;
      align-items:start;
    }
    @media (max-width: 980px){
      .grid{ grid-template-columns:1fr; }
    }

    .panel{
      background: linear-gradient(180deg, var(--card), rgba(255,255,255,.02));
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow2);
      overflow:hidden;
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
    }
    .panel .head{
      padding:18px 18px 14px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
    }
    .title{
      margin:0;
      font-size:16px;
      letter-spacing:.02em;
      color: rgba(255,255,255,.92);
    }
    .subtitle{
      margin:6px 0 0;
      font-size:13px;
      color: var(--muted);
      line-height:1.4;
    }
    .panel .body{ padding:16px 18px 18px; }

    label{
      display:block;
      font-size:12px;
      color: var(--muted);
      margin: 12px 0 6px;
      letter-spacing:.02em;
    }

    textarea, select, input[type="text"]{
      width:100%;
      border-radius: 14px;
      border:1px solid var(--field-border);
      background: var(--field-bg);
      color: rgba(255,255,255,.95);
      padding: 12px 12px;
      outline:none;
      transition: border .15s ease, box-shadow .15s ease, background .15s ease;
      box-shadow: 0 10px 30px rgba(0,0,0,.22);
    }
    textarea{
      min-height: 140px;
      resize: vertical;
    }
    textarea:focus, select:focus, input[type="text"]:focus{
      border-color: rgba(99,102,241,.62);
      box-shadow: var(--focus), 0 12px 34px rgba(0,0,0,.30);
      background: rgba(0,0,0,.38);
    }

    .row2{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
    }
    @media (max-width: 520px){
      .row2{ grid-template-columns:1fr; }
    }

    /* Upload */
    .drop{
      border-radius: 16px;
      border: 1px dashed rgba(255,255,255,.20);
      background: rgba(0,0,0,.22);
      padding: 14px;
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:space-between;
      transition: border .15s ease, background .15s ease;
      box-shadow: 0 10px 30px rgba(0,0,0,.18);
    }
    .drop:hover{
      border-color: rgba(99,102,241,.45);
      background: rgba(0,0,0,.28);
    }
    .drop-left{ display:flex; gap:12px; align-items:center; min-width:0; }
    .upload-ico{
      width:38px; height:38px;
      border-radius: 14px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
      display:grid; place-items:center;
      flex:0 0 auto;
    }
    .drop-meta{ min-width:0; }
    .drop-title{
      font-size:13px; margin:0; color: rgba(255,255,255,.90);
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .drop-sub{
      margin:4px 0 0; font-size:12px; color: var(--muted2);
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .drop-actions{ display:flex; gap:8px; align-items:center; flex:0 0 auto; }

    .btn-small{
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.92);
      padding: 9px 10px;
      border-radius: 999px;
      cursor:pointer;
      transition: transform .12s ease, background .12s ease, border .12s ease;
      font-weight:900;
      font-size:12px;
    }
    .btn-small:hover{ transform: translateY(-1px); background: rgba(255,255,255,.09); }
    .btn-small:active{ transform: translateY(0px); }

    input[type="file"]{ display:none; }

    /* Buttons */
    .btnrow{
      display:flex; gap:10px; margin-top:14px; flex-wrap:wrap;
    }
    .btn{
      flex:1 1 auto;
      border-radius: 999px;
      padding: 12px 14px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.94);
      cursor:pointer;
      font-weight:900;
      letter-spacing:.02em;
      transition: transform .12s ease, background .12s ease, box-shadow .12s ease;
      box-shadow: 0 12px 34px rgba(0,0,0,.28);
    }
    .btn:hover{ transform: translateY(-1px); background: rgba(255,255,255,.09); }
    .btn:active{ transform: translateY(0px); }
    .btn:disabled{ opacity:.55; cursor:not-allowed; transform:none; }

    .btn-primary{
      border:none;
      background: var(--grad);
      color:#fff;
      box-shadow: 0 18px 45px rgba(99,102,241,.22);
    }

    .status{
      margin-top:12px;
      font-size:12.5px;
      color: rgba(255,255,255,.72);
      min-height: 1.2em;
      white-space: pre-wrap;
    }

    /* Preview */
    .preview-head{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
    }
    .hint{
      font-size:12px;
      color: var(--muted);
      margin-top:6px;
      line-height:1.45;
    }
    .frame{
      margin-top:14px;
      border-radius: var(--radius);
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.22);
      overflow:hidden;
      position:relative;
      min-height: 320px;
      display:grid;
      place-items:center;
      box-shadow: 0 18px 60px rgba(0,0,0,.38);
    }
    .frame img{
      width:100%;
      height:100%;
      object-fit:contain;
      display:block;
      max-height: 660px;
    }
    .empty{
      padding: 34px 18px;
      text-align:center;
      color: rgba(255,255,255,.65);
      font-size:13px;
      line-height:1.55;
    }
    .empty strong{
      color: rgba(255,255,255,.92);
      font-weight:900;
    }
    .overlay{
      position:absolute; inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      background: rgba(5,7,20,.62);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
    }
    .overlay-inner{
      display:flex; align-items:center; gap:12px;
      padding: 12px 14px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.94);
      box-shadow: 0 18px 60px rgba(0,0,0,.35);
      font-weight:900;
      font-size:13px;
    }
    .spin{
      width:18px; height:18px;
      border-radius:999px;
      border: 3px solid rgba(255,255,255,.24);
      border-top-color: rgba(255,255,255,.95);
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin{ to{ transform: rotate(360deg);} }

    .meta{
      margin-top:10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      color: var(--muted2);
      font-size:12px;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 7px 10px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }

    .link{
      color: rgba(255,255,255,.92);
      text-decoration:none;
      font-weight:900;
      border-bottom:1px solid rgba(255,255,255,.22);
      padding-bottom:2px;
    }
    .link:hover{ opacity:.92; }

    /* ‚úÖ Aspect ratio */
    #aspectRatio{
      height: 42px !important;
      padding: 8px 38px 8px 12px !important;
      font-size: 13px !important;
      font-weight: 900 !important;
      border-radius: 12px !important;

      background: rgba(255,255,255,.10) !important;
      border: 1px solid rgba(255,255,255,.22) !important;
      color: rgba(255,255,255,.98) !important;

      box-shadow: 0 10px 26px rgba(0,0,0,.22) !important;

      appearance: none;
      -webkit-appearance: none;
      -moz-appearance: none;

      background-image:
        linear-gradient(45deg, transparent 50%, rgba(255,255,255,.95) 50%),
        linear-gradient(135deg, rgba(255,255,255,.95) 50%, transparent 50%);
      background-position:
        calc(100% - 16px) 50%,
        calc(100% - 11px) 50%;
      background-size: 5px 5px, 5px 5px;
      background-repeat: no-repeat;
    }
    #aspectRatio:hover{
      border-color: rgba(99,102,241,.55) !important;
      background: rgba(255,255,255,.13) !important;
    }
    #aspectRatio:focus{
      border-color: rgba(99,102,241,.75) !important;
      box-shadow: 0 0 0 4px rgba(99,102,241,.26), 0 10px 26px rgba(0,0,0,.22) !important;
    }
    #aspectRatio option{
      background: #0b1026 !important;
      color: rgba(255,255,255,.95) !important;
      font-weight: 800 !important;
    }

    /* ‚úÖ NEW: Modify box */
    .modify{
      margin-top: 14px;
      border-radius: var(--radius);
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.22);
      padding: 14px;
      box-shadow: 0 18px 60px rgba(0,0,0,.28);
      display:none; /* visible only when final image exists */
    }
    .modify .top{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      margin-bottom:10px;
    }
    .modify .top .t{
      font-weight:900;
      color: rgba(255,255,255,.92);
      font-size:13px;
    }
    .modify .top .s{
      margin-top:4px;
      font-size:12px;
      color: var(--muted2);
      line-height:1.45;
    }
    .modify textarea{ min-height: 110px; }
    .modify .actions{
      display:flex;
      gap:10px;
      margin-top:10px;
      flex-wrap:wrap;
    }
  </style>
</head>

<body>
  <div class="topbar">
    <div class="topbar-inner">
      <a href="index.html" class="brand" style="text-decoration:none;">
        <div class="logo"></div>
        <div class="logo-text" style="font-size:22px;font-weight:700;">Neora<span style="background:var(--grad);-webkit-background-clip:text;-webkit-text-fill-color:transparent;">.ai</span></div>
      </a>
      <div class="topbar-right">
        <div class="nav-links">
          <a href="index.html" class="nav-link">üè† Accueil</a>
          <a href="selector.html" class="nav-link">üöÄ App</a>
          <a href="pricing.html" class="nav-link">üíé Tarifs</a>
          <a href="historique.html" class="nav-link">üìÅ Historique</a>
          <a href="profil.html" class="nav-link">üë§ Profil</a>
          <a href="contact.html" class="nav-link">üì¨ Contact</a>
        </div>
        <div class="badge" id="generation-counter" style="background: rgba(16,185,129,0.15); border-color: rgba(16,185,129,0.3); color: #10b981;">-- g√©n√©rations restantes</div>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="grid">
      <!-- Controls -->
      <div class="panel">
        <div class="head">
          <h2 class="title">Create</h2>
          <p class="subtitle">D√©cris ce que tu veux. Ajoute une image seulement si tu veux transformer un produit existant.</p>
        </div>
        <div class="body">
          <label for="prompt_user">Prompt</label>
          <textarea id="prompt_user" placeholder="Ex: Visuel marketing premium, √©clairage studio, rendu photor√©aliste, fond sombre minimal..."></textarea>

          <label>Image (optionnel)</label>
          <div class="drop" id="dropZone">
            <div class="drop-left">
              <div class="upload-ico">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                  <path d="M12 16V4m0 0l-4 4m4-4l4 4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  <path d="M4 16v2a2 2 0 002 2h12a2 2 0 002-2v-2" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
              </div>
              <div class="drop-meta">
                <p class="drop-title" id="fileTitle">Drop image here (or browse)</p>
                <p class="drop-sub" id="fileSub">PNG / JPG ‚Ä¢ optional</p>
              </div>
            </div>
            <div class="drop-actions">
              <button type="button" class="btn-small" id="browseBtn">Browse</button>
              <button type="button" class="btn-small" id="clearBtn">Clear</button>
            </div>
            <input type="file" id="product_image" accept="image/*" />
          </div>

          <div class="row2" style="margin-top:12px;">
            <div>
              <label>Resolution</label>
              <div class="pill"><span class="mono">2K</span></div>
            </div>
            <div>
              <label for="aspectRatio">Aspect ratio</label>
              <select id="aspectRatio">
                <option value="16:9" selected>16:9</option>
                <option value="1:1">1:1</option>
                <option value="4:5">4:5</option>
                <option value="9:16">9:16</option>
                <option value="auto">auto</option>
              </select>
            </div>
          </div>

          <div class="btnrow">
            <button class="btn btn-primary" id="submit-btn">Generate</button>
            <button class="btn" id="recheck-btn" disabled>Re-check</button>
            <button class="btn" id="reset-btn">Reset</button>
          </div>

          <div class="status" id="status">Ready.</div>
        </div>
      </div>

      <!-- Preview -->
      <div class="panel">
        <div class="head">
          <div class="preview-head">
            <div>
              <h2 class="title">Result</h2>
              <div class="hint">Ton image finale s‚Äôaffiche ici.</div>
            </div>
            <a class="link" id="downloadLink" href="#" target="_blank" rel="noreferrer" style="display:none;">Download</a>
          </div>
        </div>

        <div class="body">
          <div class="frame" id="frame">
            <div class="empty" id="empty">
              <div style="font-size:14px;margin-bottom:8px;"><strong>No output yet</strong></div>
              <div>√âcris un prompt, ajoute une image si besoin, puis clique <b>Generate</b>.</div>
            </div>
            <img id="preview-image" alt="Neora result" style="display:none;" />
            <div class="overlay" id="overlay">
              <div class="overlay-inner">
                <span class="spin"></span>
                <span id="overlayText">Generating‚Ä¶</span>
              </div>
            </div>
          </div>

          <div class="meta">
            <span class="pill">Mode: <span id="mode" class="mono">text-to-image</span></span>
            <span class="pill" id="taskPill" style="display:none;">Task: <span id="taskId" class="mono"></span></span>
          </div>

          <!-- ‚úÖ NEW: Modifications (hidden until final image exists) -->
          <div class="modify" id="modifyBox">
            <div class="top">
              <div>
                <div class="t">Modifications</div>
                <div class="s">D√©cris les changements √† appliquer √† l‚Äôimage.</div>
              </div>
              <span class="pill">Base: <span class="mono" id="baseInfo">final</span></span>
            </div>

            <label for="edit_instructions">Edit instructions</label>
            <textarea id="edit_instructions" placeholder="Ex: Rends le fond plus sombre, augmente le contraste, ajoute une lumi√®re n√©on violette derri√®re le produit, garde le logo identique‚Ä¶"></textarea>

            <div class="actions">
              <button class="btn btn-primary" id="modify-btn">Apply changes</button>
              <button class="btn" id="clear-mod-btn" type="button">Clear</button>
            </div>

            <div class="status" id="modStatus" style="margin-top:10px;min-height:1.2em;"></div>
          </div>

        </div>
      </div>
    </div>
  </div>

  <script>
    // Firebase config - doit √™tre initialis√© avant tout
    const firebaseConfig = {
      apiKey: "AIzaSyCKPepYjXiY92hZPEdKxqOow9AACfMTOoc",
      authDomain: "neorastudiosnc.firebaseapp.com",
      projectId: "neorastudiosnc",
      storageBucket: "neorastudiosnc.firebasestorage.app",
      messagingSenderId: "275455765566",
      appId: "1:275455765566:web:c2cf516fcb8f13de7e356f"
    };
    
    // Initialiser Firebase si pas d√©j√† fait
    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
    
    const db = firebase.firestore();
    
    // Fonction pour cr√©er ou mettre √† jour le document utilisateur
    async function ensureUserDocument(user) {
      if (!user) return;
      
      const userRef = db.collection('users').doc(user.uid);
      const userDoc = await userRef.get();
      const currentMonth = getCurrentMonth();
      
      if (!userDoc.exists) {
        // Nouveau utilisateur ‚Üí cr√©er avec tous les champs
        await userRef.set({
          email: user.email,
          firstName: '',
          lastName: '',
          avatarUrl: user.photoURL || '',
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          lastLoginAt: firebase.firestore.FieldValue.serverTimestamp(),
          blocked: false,
          provider: user.providerData[0]?.providerId || 'email',
          plan: 'free',
          generationsAvailable: 0,
          lastBonusMonth: '',
          totalGenerations: 0,
          monthlyGenerations: 0,
          lastGenerationMonth: ''
        });
      } else {
        // Utilisateur existant ‚Üí mettre √† jour lastLoginAt
        await userRef.update({
          lastLoginAt: firebase.firestore.FieldValue.serverTimestamp()
        });
      }
    }
    
    // Fonction pour v√©rifier si l'utilisateur est bloqu√©
    async function checkIfBlocked(user) {
      if (!user) return false;
      
      const userDoc = await db.collection('users').doc(user.uid).get();
      if (userDoc.exists && userDoc.data().blocked === true) {
        alert('Votre compte a √©t√© suspendu. Contactez le support pour plus d\'informations.');
        firebase.auth().signOut();
        window.location.href = 'index.html';
        return true;
      }
      return false;
    }
    
    // Fonction pour v√©rifier si l'utilisateur a un plan payant
    async function checkPlanAccess(user) {
      if (!user) return false;
      
      const userDoc = await db.collection('users').doc(user.uid).get();
      if (userDoc.exists) {
        const plan = userDoc.data().plan || 'free';
        if (plan === 'free') {
          alert('Cette version n√©cessite un abonnement Pro. Vous allez √™tre redirig√© vers la page des tarifs.');
          window.location.href = 'pricing.html';
          return false;
        }
        return true;
      }
      return false;
    }
    
    // ========== SYST√àME DE G√âN√âRATIONS ==========
    const MONTHLY_BONUS = 50; // Bonus mensuel pour les Pro
    let generationsAvailable = 0;
    
    // Fonction pour obtenir le mois actuel au format "YYYY-MM"
    function getCurrentMonth() {
      const now = new Date();
      return `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
    }
    
    // Fonction pour charger les g√©n√©rations disponibles
    async function loadGenerations(user) {
      if (!user) return 0;
      
      const userRef = db.collection('users').doc(user.uid);
      const userDoc = await userRef.get();
      
      if (userDoc.exists) {
        const data = userDoc.data();
        const currentMonth = getCurrentMonth();
        
        // Si nouveau mois ‚Üí ajouter le bonus mensuel de 50
        if (data.lastBonusMonth !== currentMonth) {
          const currentGenerations = data.generationsAvailable || 0;
          generationsAvailable = currentGenerations + MONTHLY_BONUS;
          
          await userRef.update({
            generationsAvailable: generationsAvailable,
            lastBonusMonth: currentMonth
          });
        } else {
          generationsAvailable = data.generationsAvailable || 0;
        }
        
        updateGenerationCounter();
        return generationsAvailable;
      }
      return 0;
    }
    
    // Fonction pour v√©rifier si l'utilisateur peut encore g√©n√©rer
    function canGenerate() {
      return generationsAvailable > 0;
    }
    
    // Fonction pour d√©cr√©menter apr√®s une g√©n√©ration r√©ussie
    async function decrementGeneration(user) {
      if (!user || generationsAvailable <= 0) return;
      
      generationsAvailable--;
      
      await db.collection('users').doc(user.uid).update({
        generationsAvailable: generationsAvailable
      });
      
      updateGenerationCounter();
    }
    
    // Fonction pour mettre √† jour l'affichage du compteur
    function updateGenerationCounter() {
      const counterEl = document.getElementById('generation-counter');
      if (counterEl) {
        counterEl.textContent = `‚ö° ${generationsAvailable} g√©n√©ration${generationsAvailable > 1 ? 's' : ''}`;
        
        // Couleurs selon le nombre
        if (generationsAvailable > 20) {
          counterEl.style.color = '#10b981'; // Vert
        } else if (generationsAvailable > 5) {
          counterEl.style.color = '#f59e0b'; // Orange
        } else {
          counterEl.style.color = '#ef4444'; // Rouge
        }
      }
    }
    // ========== FIN SYST√àME DE G√âN√âRATIONS ==========
    
    // Protection: V√©rifier si l'utilisateur est connect√© et non bloqu√©
    firebase.auth().onAuthStateChanged(async (user) => {
      if (!user) {
        window.location.href = 'index.html';
        return;
      }
      
      // Cr√©er/mettre √† jour le document utilisateur
      await ensureUserDocument(user);
      
      // V√©rifier si bloqu√©
      const isBlocked = await checkIfBlocked(user);
      if (isBlocked) return;
      
      // V√©rifier si l'utilisateur a acc√®s (plan payant)
      const hasAccess = await checkPlanAccess(user);
      if (!hasAccess) return;
      
      // Charger les g√©n√©rations disponibles
      await loadGenerations(user);
    });
    
    // Initialisation du tracker NEORA
    initNeoraTracker('NEORA');
    
    const CLOUDINARY_UPLOAD_URL = "https://api.cloudinary.com/v1_1/diegfxcyl/image/upload";
    const CLOUDINARY_UPLOAD_PRESET = "neora_upload";

    const N8N_GENERATE_URL = "https://n8n.srv1125399.hstgr.cloud/webhook/c6ba0d9a-b75f-4f2e-adcc-bf529551a380";
    const N8N_STATUS_URL = ""; // optionnel

    // ‚úÖ Webhook d√©di√© aux modifications (recommand√©)
    const N8N_MODIFY_URL = ""; // ex: "https://.../webhook/xxxxx"
    const N8N_MODIFY_STATUS_URL = ""; // optionnel (sinon N8N_STATUS_URL est utilis√©)

    const $ = (id) => document.getElementById(id);

    const promptEl = $("prompt_user");
    const fileInput = $("product_image");
    const aspectEl = $("aspectRatio");

    const statusEl = $("status");
    const submitBtn = $("submit-btn");
    const recheckBtn = $("recheck-btn");
    const resetBtn = $("reset-btn");

    const empty = $("empty");
    const img = $("preview-image");
    const overlay = $("overlay");
    const overlayText = $("overlayText");

    const modeEl = $("mode");
    const taskPill = $("taskPill");
    const taskIdEl = $("taskId");

    const downloadLink = $("downloadLink");

    const dropZone = $("dropZone");
    const browseBtn = $("browseBtn");
    const clearBtn = $("clearBtn");
    const fileTitle = $("fileTitle");
    const fileSub = $("fileSub");

    // ‚úÖ modify refs
    const modifyBox = $("modifyBox");
    const editInstrEl = $("edit_instructions");
    const modifyBtn = $("modify-btn");
    const clearModBtn = $("clear-mod-btn");
    const modStatusEl = $("modStatus");

    const FIXED_RESOLUTION = "2K";

    let lastTaskId = null;
    let pollTimer = null;

    // track final image url (for edits)
    let currentFinalImageUrl = "";
    let hasFinalOutput = false;

    function setStatus(msg){ statusEl.textContent = msg || ""; }
    function setModStatus(msg){ modStatusEl.textContent = msg || ""; }

    function setOverlay(show, text){
      overlayText.textContent = text || "Generating‚Ä¶";
      overlay.style.display = show ? "flex" : "none";
    }
    function stopPolling(){ if(pollTimer) clearInterval(pollTimer); pollTimer = null; }

    function setModeFromImage(imageUrl){
      modeEl.textContent = imageUrl ? "image-to-image" : "text-to-image";
    }

    function setTask(taskId){
      lastTaskId = taskId || null;
      if(lastTaskId){
        taskPill.style.display = "inline-flex";
        taskIdEl.textContent = lastTaskId;
        recheckBtn.disabled = false;
      } else {
        taskPill.style.display = "none";
        taskIdEl.textContent = "";
        recheckBtn.disabled = true;
      }
    }

    // show image with final flag
    function showImage(url, { final = false } = {}){
      empty.style.display = "none";
      img.style.display = "block";
      img.src = url;

      if(final){
        downloadLink.href = url;
        downloadLink.style.display = "inline-block";
        currentFinalImageUrl = url;
        hasFinalOutput = true;
        modifyBox.style.display = "block";
      } else {
        downloadLink.style.display = "none";
        downloadLink.href = "#";
        currentFinalImageUrl = "";
        hasFinalOutput = false;
        modifyBox.style.display = "none";
        setModStatus("");
      }
    }

    function clearResult(){
      img.style.display = "none";
      img.src = "";
      empty.style.display = "block";
      downloadLink.style.display = "none";
      downloadLink.href = "#";

      currentFinalImageUrl = "";
      hasFinalOutput = false;
      modifyBox.style.display = "none";
      setModStatus("");
    }

    function normalizeResponse(data){
      const image =
        data?.resultImageUrl ||
        data?.image_url ||
        data?.myField ||
        data?.data?.response?.resultImageUrl ||
        data?.data?.info?.resultImageUrl ||
        "";

      const taskId =
        data?.taskId ||
        data?.data?.taskId ||
        data?.data?.response?.taskId ||
        "";

      const successFlag =
        data?.successFlag ??
        data?.data?.successFlag ??
        null;

      let status = data?.status || "";
      if (!status) {
        if (image) status = "done";
        else if (successFlag == 2 || successFlag == "2" || successFlag == 3 || successFlag == "3") status = "failed";
        else status = "processing";
      }

      const errorMessage = data?.errorMessage || data?.data?.errorMessage || data?.message || "";
      return { status, image, taskId, successFlag, errorMessage };
    }

    async function uploadToCloudinary(file){
      const fd = new FormData();
      fd.append("file", file);
      fd.append("upload_preset", CLOUDINARY_UPLOAD_PRESET);

      const res = await fetch(CLOUDINARY_UPLOAD_URL, { method:"POST", body: fd });
      if(!res.ok) throw new Error("Cloudinary upload failed");
      const json = await res.json();
      if(!json.secure_url) throw new Error("Cloudinary: missing secure_url");
      return json.secure_url;
    }

    async function postJson(url, payload){
      const res = await fetch(url, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify(payload)
      });

      if(!res.ok){
        const txt = await res.text().catch(()=> "");
        throw new Error("n8n error: " + (txt || res.status));
      }
      return await res.json();
    }

    async function callGenerate(payload){
      return postJson(N8N_GENERATE_URL, payload);
    }

    async function callModify(payload){
      const url = (N8N_MODIFY_URL || N8N_GENERATE_URL);
      return postJson(url, payload);
    }

    async function callStatus(taskId, forceUrl){
      const statusUrl = forceUrl || N8N_STATUS_URL;
      if(!statusUrl) throw new Error("STATUS_URL not configured");

      const url = statusUrl.includes("?")
        ? `${statusUrl}&taskId=${encodeURIComponent(taskId)}`
        : `${statusUrl}?taskId=${encodeURIComponent(taskId)}`;

      const res = await fetch(url, { method:"GET" });
      if(!res.ok) throw new Error("status error: " + res.status);
      return await res.json();
    }

    function startPolling(taskId, { statusUrlOverride = "" } = {}){
      const statusUrl = statusUrlOverride || N8N_STATUS_URL;
      if(!statusUrl) return;

      stopPolling();
      pollTimer = setInterval(async () => {
        try{
          const data = await callStatus(taskId, statusUrl);
          const r = normalizeResponse(data);

          if(r.status === "done" && r.image){
            stopPolling();
            setOverlay(false);
            setStatus("Done ‚úÖ");
            showImage(r.image, { final:true });
          } else if(r.status === "failed"){
            stopPolling();
            setOverlay(false);
            setStatus("Failed ‚ùå " + (r.errorMessage || ""));
          } else {
            setStatus("Processing‚Ä¶ (polling)");
          }
        } catch(e){
          setStatus("Polling: " + (e.message || e));
        }
      }, 2000);
    }

    function updateFileUI(file){
      if(!file){
        fileTitle.textContent = "Drop image here (or browse)";
        fileSub.textContent = "PNG / JPG ‚Ä¢ optional";
        return;
      }
      fileTitle.textContent = file.name;
      fileSub.textContent = `${Math.round(file.size/1024)} KB ‚Ä¢ ready`;
    }

    browseBtn.addEventListener("click", () => fileInput.click());
    clearBtn.addEventListener("click", () => {
      fileInput.value = "";
      updateFileUI(null);
      setModeFromImage("");
      setStatus("Image cleared.");
    });

    fileInput.addEventListener("change", () => {
      const f = fileInput.files?.[0] || null;
      updateFileUI(f);
      if(f){
        setModeFromImage("x");
        const url = URL.createObjectURL(f);
        clearResult();
        // preview only
        showImage(url, { final:false });
        setStatus("Image ready (optional).");
      } else {
        setModeFromImage("");
      }
    });

    ;["dragenter","dragover"].forEach(evt => {
      dropZone.addEventListener(evt, (e) => {
        e.preventDefault();
        dropZone.style.borderColor = "rgba(99,102,241,.55)";
        dropZone.style.background = "rgba(0,0,0,.30)";
      });
    });
    ;["dragleave","drop"].forEach(evt => {
      dropZone.addEventListener(evt, (e) => {
        e.preventDefault();
        dropZone.style.borderColor = "rgba(255,255,255,.20)";
        dropZone.style.background = "rgba(0,0,0,.22)";
      });
    });
    dropZone.addEventListener("drop", (e) => {
      const f = e.dataTransfer.files?.[0];
      if(!f) return;
      fileInput.files = e.dataTransfer.files;
      updateFileUI(f);
      setModeFromImage("x");
      const url = URL.createObjectURL(f);
      clearResult();
      // preview only
      showImage(url, { final:false });
      setStatus("Image ready (optional).");
    });

    submitBtn.addEventListener("click", async () => {
      stopPolling();
      setStatus("");
      setTask(null);
      setModStatus("");

      // V√©rifier la limite de g√©n√©rations
      if (!canGenerate()) {
        setStatus("‚ùå Plus de g√©n√©rations disponibles !");
        alert('Vous n\'avez plus de g√©n√©rations disponibles. Achetez un pack de cr√©dits pour continuer.');
        return;
      }

      const prompt = (promptEl.value || "").trim();
      if(!prompt){
        setStatus("Write a prompt first.");
        return;
      }

      submitBtn.disabled = true;
      recheckBtn.disabled = true;
      modifyBtn.disabled = true;

      setOverlay(true, "Generating‚Ä¶");
      setStatus("Processing‚Ä¶");
      clearResult();

      try{
        const aspectRatio = aspectEl.value;
        const file = fileInput.files?.[0] || null;
        let image_url = "";

        if(file){
          setOverlay(true, "Uploading image‚Ä¶");
          image_url = await uploadToCloudinary(file);
        }

        setModeFromImage(image_url);

        const payload = {
          prompt_user: prompt,
          resolution: FIXED_RESOLUTION,
          aspectRatio
        };
        if(image_url) payload.image_url = image_url;

        const data = await callGenerate(payload);
        const r = normalizeResponse(data);

        if(r.taskId) setTask(r.taskId);

        if(r.status === "done" && r.image){
          setOverlay(false);
          setStatus("Done ‚úÖ");
          showImage(r.image, { final:true });
          modifyBtn.disabled = false;
          
          // D√©cr√©menter le compteur de g√©n√©rations
          const user = firebase.auth().currentUser;
          if (user) {
            await decrementGeneration(user);
          }
          
          // Sauvegarde dans l'historique
          saveGeneration({
            imageUrl: r.image,
            prompt: prompt,
            aspectRatio: aspectRatio,
            mode: image_url ? 'image-to-image' : 'text-to-image'
          });
        } else if(r.status === "failed"){
          setOverlay(false);
          setStatus("Failed ‚ùå " + (r.errorMessage || ""));
        } else {
          setStatus("Processing‚Ä¶ (not ready on first check)");
          if(r.taskId && N8N_STATUS_URL) startPolling(r.taskId);
        }

      } catch(e){
        setOverlay(false);
        setStatus("Error: " + (e.message || e));
      } finally {
        submitBtn.disabled = false;
        modifyBtn.disabled = !hasFinalOutput;
      }
    });

    recheckBtn.addEventListener("click", async () => {
      if(!lastTaskId){
        setStatus("No taskId.");
        return;
      }
      if(!N8N_STATUS_URL){
        setStatus("Re-check unavailable: add a /status endpoint in n8n (record-info GET).");
        return;
      }

      try{
        setOverlay(true, "Checking‚Ä¶");
        setStatus("Re-check‚Ä¶");
        const data = await callStatus(lastTaskId, N8N_STATUS_URL);
        const r = normalizeResponse(data);

        if(r.status === "done" && r.image){
          setOverlay(false);
          setStatus("Done ‚úÖ");
          showImage(r.image, { final:true });
          modifyBtn.disabled = false;
        } else if(r.status === "failed"){
          setOverlay(false);
          setStatus("Failed ‚ùå " + (r.errorMessage || ""));
        } else {
          setOverlay(true, "Still processing‚Ä¶");
          setStatus("Still processing‚Ä¶");
          startPolling(lastTaskId);
        }
      } catch(e){
        setOverlay(false);
        setStatus("Re-check error: " + (e.message || e));
      }
    });

    // ‚úÖ Apply edits (edit_instructions)
    modifyBtn.addEventListener("click", async () => {
      if(!hasFinalOutput || !currentFinalImageUrl){
        setModStatus("Aucune image finale √† modifier.");
        return;
      }

      const edit_instructions = (editInstrEl.value || "").trim();
      if(!edit_instructions){
        setModStatus("√âcris des edit_instructions.");
        return;
      }

      modifyBtn.disabled = true;
      submitBtn.disabled = true;
      recheckBtn.disabled = true;

      const previousFinal = currentFinalImageUrl;

      try{
        setOverlay(true, "Applying changes‚Ä¶");
        setModStatus("Processing‚Ä¶");

        const payload = {
          image_url: currentFinalImageUrl,
          edit_instructions,              // ‚úÖ renamed key
          resolution: FIXED_RESOLUTION,
          aspectRatio: aspectEl.value,
          mode: "modify"
        };

        const data = await callModify(payload);
        const r = normalizeResponse(data);

        if(r.taskId) setTask(r.taskId);

        if(r.status === "done" && r.image){
          setOverlay(false);
          setModStatus("Done ‚úÖ");
          showImage(r.image, { final:true });
          editInstrEl.value = "";
        } else if(r.status === "failed"){
          setOverlay(false);
          setModStatus("Failed ‚ùå " + (r.errorMessage || ""));
          showImage(previousFinal, { final:true });
        } else {
          setModStatus("Processing‚Ä¶ (not ready on first check)");
          const sUrl = (N8N_MODIFY_STATUS_URL || N8N_STATUS_URL);
          if(r.taskId && sUrl) startPolling(r.taskId, { statusUrlOverride: sUrl });
        }

      } catch(e){
        setOverlay(false);
        setModStatus("Error: " + (e.message || e));
        showImage(previousFinal, { final:true });
      } finally {
        submitBtn.disabled = false;
        modifyBtn.disabled = false;
        recheckBtn.disabled = !lastTaskId;
      }
    });

    clearModBtn.addEventListener("click", () => {
      editInstrEl.value = "";
      setModStatus("");
    });

    resetBtn.addEventListener("click", () => {
      stopPolling();
      promptEl.value = "";
      fileInput.value = "";
      updateFileUI(null);
      setModeFromImage("");
      setTask(null);
      clearResult();
      setOverlay(false);
      setStatus("Ready.");
    });

    setStatus("Ready.");
    updateFileUI(null);
    setModeFromImage("");
  </script>
<script src="neora-cache.js"></script>
</body>
</html>
